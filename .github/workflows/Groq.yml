name: ðŸ¤– Generate iFlow Documentation (Groq + Auto-Diagram)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "CPI package folder inside cpi-artifacts"
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
      - uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Documentation with Groq + Auto Diagram
        id: documentation_step
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          set -e
          
          BASE="cpi-artifacts/$PKG_ID"
          MODEL="llama-3.3-70b-versatile"
          URL="https://api.groq.com/openai/v1/chat/completions"

          echo "ðŸ”‘ API Key Length: ${#GROQ_API_KEY}"
          echo "ðŸ“¦ Processing Package: $PKG_ID"

          if [ ! -d "$BASE" ]; then
            echo "::error::Package not found: $BASE"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect.
          Your job is to generate iFlow documentation AND a **valid GitHub Mermaid Diagram**.
          
          STRICT MERMAID RULES:
          - Must be inside ```mermaid fenced block
          - Must begin with: graph TD
          - Allowed arrows: --> and -->|Label|
          - DO NOT use > or |Label|>
          - DO NOT use styling: no style A..., no fill:, no stroke:
          - Only high-level nodes allowed: Sender, CPI, Receiver, or major business steps.
          - Must render correctly on GitHub. 
          If unsure â†’ Produce simplest graph: Sender --> CPI --> Receiver.
          "

          # Find iFlows
          IFlows=$(find "$BASE" -type f \( -name "*.iflw" -o -name "iFlowContent.xml" \))
          ROOTS=$(echo "$IFlows" | sed "s|^$BASE/||" | cut -d/ -f1 | sort -u)
          ALL_DOCS=false

          # Mermaid Cleaner Function (Bash)
          clean_mermaid() {
            echo "$1" |
              sed 's/>//g' |
              sed 's/|>//g' |
              sed 's/|[^|]*|>/|/g' |
              sed 's/style .*//g' |
              sed 's/-->|/>/g' |
              sed 's/| >/|/g' |
              sed 's/|  >/|/g' |
              sed 's/|>/|/g'
          }

          # Auto-Fallback Mermaid Generator
          fallback_diagram() {
            cat <<EOF
            \`\`\`mermaid
            graph TD
            Sender[Sender System] --> CPI[CPI]
            CPI --> Receiver[Receiver System]
            \`\`\`
             EOF
          }

          for R in $ROOTS; do
            DIR="$BASE/$R"
            OUT="$DIR/iFlow_Summary.md"
            echo "=================================================="
            echo "âž¡ Processing iFlow: $R"

            FILES=$(find "$DIR" -type f \( -name "*.iflw" -o -name "*.xml" -o -name "*.json" -o -name "*.groovy" -o -name "*.xslt" \))
            CONTENT=""
            for F in $FILES; do
              T=$(cat "$F")
              CONTENT+="\n--- FILE: $F ---\n$T\n--- END FILE ---\n"
            done

            USER_PROMPT="Generate documentation for iFlow '$R'.
            Include a valid Mermaid diagram following STRICT RULES.

            \`\`\`text
            $CONTENT
            \`\`\`
            "

            PAYLOAD=$(jq -n \
              --arg m "$MODEL" \
              --arg sys "$SYSTEM_PROMPT" \
              --arg usr "$USER_PROMPT" \
              '{
                model: $m,
                messages: [
                  {role: "system", content: $sys},
                  {role: "user", content: $usr}
                ],
                temperature: 0.1
              }')

            # Call Groq
            RESP=$(curl -s -X POST "$URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer '"$GROQ_API_KEY"'" \
              -d "$PAYLOAD")

            RAW=$(echo "$RESP" | jq -r '.choices[0].message.content')

            if [ "$RAW" = "null" ] || [ -z "$RAW" ]; then
              echo "âš ï¸ No output from Groq â€” generating fallback documentation"
              FINAL_DOC="Fallback documentation only.\n\n$(fallback_diagram)"
            else
              # Extract Mermaid block
              DIAG=$(echo "$RAW" | sed -n '/```mermaid/,/```/p')
              CLEANED=$(clean_mermaid "$DIAG")

              # If diagram missing or too small â†’ use fallback
              if echo "$CLEANED" | grep -q "graph TD"; then
                FINAL_DOC=$(echo "$RAW" | sed "s|$DIAG|$CLEANED|")
              else
                echo "âš ï¸ No valid diagram â€” using fallback."
                FINAL_DOC="$RAW\n\n$(fallback_diagram)"
              fi
            fi

            echo "$FINAL_DOC" > "$OUT"
            echo "âœ… Saved documentation â†’ $OUT"
            ALL_DOCS=true
          done

          echo "docs_generated=$ALL_DOCS" >> $GITHUB_OUTPUT

      - name: Commit Generated Docs
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "cpi-artifacts/${{ github.event.inputs.package_id }}/**/iFlow_Summary.md"
          git commit -m "ðŸ“˜ Auto-generated iFlow documentation with Mermaid diagrams"
          git push
