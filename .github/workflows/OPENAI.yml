name: ü§ñ Generation Individual iFlow Documentation (DOCX)
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package"
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          pip3 install python-docx requests
      - name: Generate DOCX Documentation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # 1Ô∏è‚É£ CREATE THE PYTHON SCRIPT
          cat << 'EOF' > generate_docx.py
          import sys, requests, os
          from docx import Document
          from docx.shared import Inches, Pt, RGBColor
          from docx.enum.text import WD_ALIGN_PARAGRAPH
          from docx.oxml.ns import qn
          from docx.oxml import OxmlElement
          def add_numbered_heading(doc, text, level, num_str):
              p = doc.add_heading(level=level)
              run = p.add_run(f"{num_str} {text}")
              run.font.color.rgb = RGBColor(31, 56, 100)
              if level == 1:
                  run.font.size = Pt(16)
              else:
                  run.font.size = Pt(13)
          def build_docx(iflow_name, author, date, ai_content, output_path):
              doc = Document()
              
              # --- HEADER (LOGOS ON EVERY PAGE) ---
              section = doc.sections[0]
              header = section.header
              htable = header.add_table(1, 2, width=Inches(6.5))
              htable.allow_autofit = False
              
              sap_url = "https://raw.githubusercontent.com/Akila710/CPI_Demo1/main/assets/logos/SAP.jpg"
              mm_url = "https://raw.githubusercontent.com/Akila710/CPI_Demo1/main/assets/logos/mm_logo.png"
              try:
                  with open("sap.jpg", "wb") as f: f.write(requests.get(sap_url).content)
                  with open("mm.png", "wb") as f: f.write(requests.get(mm_url).content)
                  htable.rows[0].cells[0].paragraphs[0].add_run().add_picture("sap.jpg", height=Inches(0.75))
                  mm_p = htable.rows[0].cells[1].paragraphs[0]
                  mm_p.alignment = WD_ALIGN_PARAGRAPH.RIGHT
                  mm_p.add_run().add_picture("mm.png", height=Inches(0.75))
              except: pass
              # --- PAGE 1: COVER PAGE ---
              for _ in range(5): doc.add_paragraph()
              title_p = doc.add_paragraph()
              title_p.alignment = WD_ALIGN_PARAGRAPH.CENTER
              run = title_p.add_run(iflow_name)
              run.font.size = Pt(32)
              run.font.bold = True
              run.font.color.rgb = RGBColor(31, 56, 100)
              doc.add_paragraph("Technical Specification Document").alignment = WD_ALIGN_PARAGRAPH.CENTER
              doc.add_paragraph("\n" * 2)
              meta = doc.add_table(rows=3, cols=2)
              meta.alignment = WD_ALIGN_PARAGRAPH.CENTER
              meta.style = 'Table Grid'
              for i, (l, v) in enumerate([("Author:", author), ("Date:", date), ("Version:", "1.0")]):
                  meta.rows[i].cells[0].text = l
                  meta.rows[i].cells[1].text = v
              
              doc.add_page_break()
              # --- PAGE 2: TABLE OF CONTENTS ---
              doc.add_heading("Table of Contents", level=1).runs[0].font.color.rgb = RGBColor(31, 56, 100)
              items = [
                  ("1. Introduction", 0), ("1.1 Purpose", 1), ("1.2 Scope", 1),
                  ("2. Integration Overview", 0), ("2.1 Integration Architecture", 1), ("2.2 Integration Components", 1),
                  ("3. Integration Scenarios", 0), ("3.1 Scenario Description", 1), ("3.2 Data Flows", 1),
                  ("4. Error Handling", 0), ("5. Testing Validation", 0)
              ]
              for text, ind in items:
                  p = doc.add_paragraph(text)
                  if ind == 1: p.paragraph_format.left_indent = Inches(0.3)
              
              doc.add_page_break()
              # --- PAGE 3: TECHNICAL CONTENT ---
              add_numbered_heading(doc, "Introduction", 1, "1.")
              add_numbered_heading(doc, "Purpose", 2, "1.1")
              doc.add_paragraph("This document provides a detailed explanation of the solution as conceptualized for " + iflow_name + ".")
              
              add_numbered_heading(doc, "Scope", 2, "1.2")
              doc.add_paragraph("The technical specification outlines integration touchpoints and business scenarios required for consistent identity management.")
              add_numbered_heading(doc, "Integration Overview", 1, "2.")
              add_numbered_heading(doc, "Integration Architecture", 2, "2.1")
              doc.add_paragraph("The integration architecture follows the standard SAP BTP Cloud Integration pattern.")
              add_numbered_heading(doc, "Integration Scenarios", 1, "3.")
              add_numbered_heading(doc, "Scenario Description", 2, "3.1")
              doc.add_paragraph(ai_content)
              
              doc.save(output_path)
          
          if __name__ == "__main__":
              build_docx(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4], sys.argv[5])
          EOF
          # 2Ô∏è‚É£ EXECUTION
          BASE_DIR="cpi-artifacts/$PKG_ID"
          for IFLOW_DIR in "$BASE_DIR"/*; do
            if [ -d "$IFLOW_DIR" ]; then
              IFLOW_NAME=$(basename "$IFLOW_DIR")
              AUTHOR=$(git log -1 --pretty=format:'%an' || echo "Technical Lead")
              DATE=$(date +%Y-%m-%d)
              
              AI_CONTENT=$(curl -s https://api.openai.com/v1/chat/completions \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -H "Content-Type: application/json" \
                -d "{\"model\": \"gpt-4o-mini\", \"messages\": [{\"role\": \"user\", \"content\": \"Write a detailed technical scenario description for SAP CPI iFlow: $IFLOW_NAME. Include logic and transformation details.\"}]}" \
                | jq -r '.choices[0].message.content')
              
              python3 generate_docx.py "$IFLOW_NAME" "$AUTHOR" "$DATE" "$AI_CONTENT" "$IFLOW_DIR/${IFLOW_NAME}.docx"
            fi
          done
      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "ü§ñ DOCS: Standard format - Content starts Page 3" || echo "No changes"
          git push
