name: ü§ñ Generation Individual iFlow Documentation (DOCX)
on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'Demo')"
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          pip3 install python-docx requests

      - name: Generate DOCX Documentation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # 1Ô∏è‚É£ CREATE THE PYTHON SCRIPT ON THE FLY
          cat << 'EOF' > generate_docx.py
          import sys, requests, os
          from docx import Document
          from docx.shared import Inches, Pt
          from docx.enum.text import WD_ALIGN_PARAGRAPH

          def build_docx(iflow_name, author, date, ai_text, output_path):
              doc = Document()
              
              # --- Setup Header (Repeats on every page) ---
              section = doc.sections[0]
              header = section.header
              htable = header.add_table(1, 2, width=Inches(6))
              
              # Download Logos
              sap_url = "https://raw.githubusercontent.com/Akila710/CPI_Demo1/main/assets/logos/SAP.jpg"
              mm_url = "https://raw.githubusercontent.com/Akila710/CPI_Demo1/main/assets/logos/mm_logo.png"
              
              with open("sap.jpg", "wb") as f: f.write(requests.get(sap_url).content)
              with open("mm.png", "wb") as f: f.write(requests.get(mm_url).content)

              # Left Logo (SAP)
              sap_run = htable.rows[0].cells[0].paragraphs[0].add_run()
              sap_run.add_picture("sap.jpg", height=Inches(0.4))
              
              # Right Logo (MM)
              mm_para = htable.rows[0].cells[1].paragraphs[0]
              mm_para.alignment = WD_ALIGN_PARAGRAPH.RIGHT
              mm_run = mm_para.add_run()
              mm_run.add_picture("mm.png", height=Inches(0.4))

              # --- Cover Page ---
              doc.add_heading(iflow_name, 0)
              doc.add_paragraph("Technical Specification Document").alignment = WD_ALIGN_PARAGRAPH.CENTER
              
              table = doc.add_table(rows=3, cols=2)
              table.style = 'Table Grid'
              data = [("Author", author), ("Date", date), ("Version", "1.0")]
              for i, (label, val) in enumerate(data):
                  table.rows[i].cells[0].text = label
                  table.rows[i].cells[1].text = val
              
              doc.add_page_break()

              # --- Content Page ---
              doc.add_heading("Functional & Technical Overview", level=1)
              doc.add_paragraph(ai_text)
              
              doc.save(output_path)
          
          if __name__ == "__main__":
              build_docx(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4], sys.argv[5])
          EOF

          # 2Ô∏è‚É£ LOOP THROUGH IFLOWS AND CALL THE SCRIPT
          BASE_DIR="cpi-artifacts/$PKG_ID"
          for IFLOW_DIR in "$BASE_DIR"/*; do
            if [ -d "$IFLOW_DIR" ]; then
              IFLOW_NAME=$(basename "$IFLOW_DIR")
              AUTHOR=$(git log -1 --pretty=format:'%an' || echo "GitHub Action")
              DATE=$(date +%Y-%m-%d)
              
              # Get Documentation from OpenAI
              RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -H "Content-Type: application/json" \
                -d "{
                  \"model\": \"gpt-4o-mini\",
                  \"messages\": [{\"role\": \"system\", \"content\": \"You are a technical writer.\"}, 
                                {\"role\": \"user\", \"content\": \"Generate technical documentation for CPI iFlow: $IFLOW_NAME\"}]
                }")
              
              AI_CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')
              
              # Run the generated Python script
              python3 generate_docx.py "$IFLOW_NAME" "$AUTHOR" "$DATE" "$AI_CONTENT" "$IFLOW_DIR/${IFLOW_NAME}.docx"
            fi
          done

      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add cpi-artifacts/${{ github.event.inputs.package_id }}/*.docx
          git commit -m "ü§ñ DOCS: Generated Word files with headers" || echo "No changes to commit"
          git push
