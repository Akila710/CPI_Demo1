name: ðŸ¤– Generate Individual iFlow Documentation (DOCX Only)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "CPI Integration Package ID (e.g., Demo)"
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest

    steps:
    # ------------------------------------------------------
    # CHECKOUT REPOSITORY
    # ------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ------------------------------------------------------
    # INSTALL DEPENDENCIES
    # ------------------------------------------------------
    - name: Install jq + pandoc
      run: |
        sudo apt-get update
        sudo apt-get install -y jq pandoc

    # ------------------------------------------------------
    # CREATE SYSTEM PROMPT FILE (SAFE HEREDOC)
    # ------------------------------------------------------
    - name: Create system prompt file
      run: |
        cat << 'EOF' > system_prompt.txt
You are a senior SAP CPI Technical Architect. Analyze all provided iFlow artifacts and generate a structured Markdown documentation with EXACTLY these 10 sections:

1. High-level architecture
2. Purpose of this iFlow
3. Sender/Receiver systems
4. Adapter types used
5. Step-by-step flow explanation
6. Mapping logic summary (XSLT, mappings)
7. Groovy script explanation
8. Error handling
9. Security/authentication
10. High-Level Process Flow Diagram (Mermaid)

IMPORTANT:
DO NOT use triple backticks for Mermaid.
Instead wrap the diagram like:

<MERMAID>
  graph TD
  Sender --> CPI
  CPI --> Receiver
</MERMAID>
EOF

    # ------------------------------------------------------
    # GENERATE DOCUMENTATION
    # ------------------------------------------------------
    - name: Generate iFlow Documentation via OpenAI
      id: documentation_step
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        PKG_ID: ${{ github.event.inputs.package_id }}

      run: |
        set -e

        API_URL="https://api.openai.com/v1/chat/completions"
        MODEL_NAME="gpt-4o-mini"
        BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

        if [ ! -d "$BASE_PKG_DIR" ]; then
          echo "::error::Package folder not found: $BASE_PKG_DIR"
          echo "docs_generated=false" >> $GITHUB_OUTPUT
          exit 1
        fi

        SYSTEM_PROMPT="$(cat system_prompt.txt)"

        echo "ðŸ” Searching for iFlows inside $BASE_PKG_DIR ..."

        # Find all iFlow definitions
        IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name "iFlowContent.xml" -o -name "*.iflw" \))

        if [ -z "$IFLOW_PATHS" ]; then
          echo "::warning::No iFlows found."
          echo "docs_generated=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        ROOT_FOLDERS=$(echo "$IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)

        ALL_DOCS=false

        for ROOT in $ROOT_FOLDERS; do
          IFLOW_DIR="$BASE_PKG_DIR/$ROOT"
          IFLOW_NAME=$(basename "$IFLOW_DIR")

          MD_FILE="$IFLOW_DIR/iFlow_Summary.md"
          QUERY_FILE="$IFLOW_DIR/query.txt"

          echo "âž¡ Processing iFlow: $IFLOW_NAME"

          # Collect artifacts
          ARTIFACT_DATA=""
          FILE_LIST=$(find "$IFLOW_DIR" -type f \( -name "*.groovy" -o -name "*.xslt" -o -name "*.iflw" -o -name "iFlowContent.xml" \))

          for FILE in $FILE_LIST; do
            ARTIFACT_DATA="${ARTIFACT_DATA}\n\n--- FILE: $FILE ---\n$(cat "$FILE")\n--- END FILE ---\n"
          done

          printf "Generate documentation for iFlow '%s'.\nArtifacts:\n%s" "$IFLOW_NAME" "$ARTIFACT_DATA" > "$QUERY_FILE"

          PAYLOAD=$(jq -n \
            --arg system "$SYSTEM_PROMPT" \
            --rawfile query "$QUERY_FILE" \
            --arg model "$MODEL_NAME" \
            '{
              model: $model,
              messages: [
                {role: "system", content: $system},
                {role: "user", content: $query}
              ],
              temperature: 0.1
            }')

          RESPONSE=$(curl -s -X POST "$API_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer '"$OPENAI_API_KEY"'" \
            -d "$PAYLOAD")

          GENERATED_TEXT=$(echo "$RESPONSE" | jq -r ".choices[0].message.content")

          if [ -z "$GENERATED_TEXT" ] || [ "$GENERATED_TEXT" = "null" ]; then
            echo "âŒ No documentation generated for $IFLOW_NAME"
            continue
          fi

          echo "$GENERATED_TEXT" > "$MD_FILE"
          echo "âœ… Saved: $MD_FILE"

          ALL_DOCS=true

          rm "$QUERY_FILE"
        done

        echo "docs_generated=$ALL_DOCS" >> $GITHUB_OUTPUT

    # ------------------------------------------------------
    # AUTO-COMMIT GENERATED FILES
    # ------------------------------------------------------
    - name: Commit generated documentation
      if: steps.documentation_step.outputs.docs_generated == 'true'
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"

        PKG_ID="${{ github.event.inputs.package_id }}"

        git add cpi-artifacts/$PKG_ID/**/iFlow_Summary.md

        if git diff --cached --quiet; then
          echo "No new documentation created."
          exit 0
        fi

        git commit -m "ðŸ¤– DOCS: Generated iFlow documentation for package: $PKG_ID"
        git push
