name: ü§ñ Generation Individual iFlow Documentation (PDF)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'Demo')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # ------------------------------------------------------------
      # 1Ô∏è‚É£ Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2Ô∏è‚É£ Install Dependencies (NO LaTeX)
      # ------------------------------------------------------------
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq wkhtmltopdf

      # ------------------------------------------------------------
      # 3Ô∏è‚É£ Create INLINE HTML Assets (HEADER + COVER)
      # ------------------------------------------------------------
      - name: Create HTML Assets
        run: |
          mkdir -p pdf_assets

          # ==========================================================
          # HEADER HTML (FULL HTML ‚Äì REQUIRED BY wkhtmltopdf)
          # LOGOS REPEAT ON EVERY PAGE
          # ==========================================================
          cat <<'EOF' > pdf_assets/header.html
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>
              body {
                margin: 0;
                padding: 0;
                font-size: 10px;
              }
              table {
                width: 100%;
                border-bottom: 1px solid #ccc;
              }
              img {
                height: 40px;
              }
            </style>
          </head>
          <body>
            <table>
              <tr>
                <td align="left">
                  <img src="assets/logos/SAP.jpg">
                </td>
                <td align="right">
                  <img src="assets/logos/mm_logo.png">
                </td>
              </tr>
            </table>
          </body>
          </html>
          EOF

          # ==========================================================
          # COVER PAGE (PAGE 1)
          # ==========================================================
          cat <<'EOF' > pdf_assets/cover.html
          <!DOCTYPE html>
          <html>
          <body>
            <div style="text-align:center; margin-top:200px;">
              <h1 style="font-size:42px;">{{IFLOW_NAME}}</h1>
              <h2>Technical Specification Document</h2>

              <div style="margin-top:120px;">
                <table border="1" cellpadding="8" cellspacing="0"
                       align="center" width="60%">
                  <tr><th align="left">Author</th><td>{{AUTHOR}}</td></tr>
                  <tr><th align="left">Date</th><td>{{DATE}}</td></tr>
                  <tr><th align="left">Version</th><td>{{VERSION}}</td></tr>
                </table>
              </div>
            </div>

            <div style="page-break-after: always;"></div>
          </body>
          </html>
          EOF

      # ------------------------------------------------------------
      # 4Ô∏è‚É£ Generate PDF (wkhtmltopdf ‚Äì LOGOS ON EVERY PAGE)
      # ------------------------------------------------------------
      - name: Generate PDF Documentation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          set -e

          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_DIR="cpi-artifacts/$PKG_ID"

          [ -d "$BASE_DIR" ] || { echo "::error::Package not found"; exit 1; }

          for IFLOW_DIR in "$BASE_DIR"/*; do
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_PDF="$IFLOW_DIR/${IFLOW_NAME}.pdf"

            AUTHOR=$(git log -1 --pretty=format:'%an')
            DATE=$(date +%Y-%m-%d)
            VERSION="1.0"

            # ------------------------------------------------------
            # OpenAI request ‚Äì STRICT HTML ONLY
            # ------------------------------------------------------
            jq -n \
              --arg model "$MODEL_NAME" \
              --arg system "Generate STRICT HTML only. No markdown. No backticks. Use h1,h2,p,ul,li,table,tr,td,th only." \
              --arg user "Generate technical documentation for iFlow $IFLOW_NAME." \
              '{model:$model,messages:[{role:"system",content:$system},{role:"user",content:$user}],temperature:0.1}' \
              > payload.json

            RESPONSE=$(curl -s \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload.json "$API_URL")

            # ------------------------------------------------------
            # Build FINAL HTML (Cover + Content)
            # ------------------------------------------------------
            sed -e "s/{{IFLOW_NAME}}/$IFLOW_NAME/" \
                -e "s/{{AUTHOR}}/$AUTHOR/" \
                -e "s/{{DATE}}/$DATE/" \
                -e "s/{{VERSION}}/$VERSION/" \
                pdf_assets/cover.html > final.html

            echo "$RESPONSE" | jq -r '.choices[0].message.content' >> final.html

            # ------------------------------------------------------
            # Convert to PDF (HEADER ON EVERY PAGE)
            # ------------------------------------------------------
            wkhtmltopdf \
              --enable-local-file-access \
              --header-html pdf_assets/header.html \
              --header-spacing 5 \
              --margin-top 30mm \
              final.html "$OUTPUT_PDF"

            rm -f payload.json final.html
          done

      # ------------------------------------------------------------
      # 5Ô∏è‚É£ Commit & Push PDFs
      # ------------------------------------------------------------
      - name: Commit and Push PDFs
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add cpi-artifacts/${{ github.event.inputs.package_id }}/*.pdf
          git commit -m "ü§ñ DOCS: PDF with logos on every page"
          git push
