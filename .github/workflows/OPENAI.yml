name: ðŸ¤– Generation Individual iFlow Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFconverter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          HEADING_COLOR: "#1f4e79"
        run: |
          set -e

          # ---------------- CONFIG ----------------
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found: $BASE_PKG_DIR"
            exit 1
          fi

          # ---------------- SYSTEM PROMPT ----------------
          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Produce a professional Technical Specification Document.

          CRITICAL REQUIREMENTS:
          - Deep technical explanation based strictly on provided artifacts
          - No assumptions beyond artifacts

          FORMATTING:
          - All H1/H2 headings must use color '${{ env.HEADING_COLOR }}'
          - Subheadings must be bold and colored
          - Use Markdown tables
          - Separate sections with blank lines

          REQUIRED STRUCTURE:
          <h1 style=\"color:${{ env.HEADING_COLOR }};\">Table of Contents</h1>
          1. Introduction <br>
          1.1 Purpose <br>
          1.2 Scope <br>
          2. Integration Overview <br>
          2.1 Integration Architecture <br>
          2.2 Integration Components <br>
          3. Integration Scenarios <br>
          3.1 Scenario Description <br>
          3.2 Data Flows <br>
          3.3 Security Requirements <br>
          4. Error Handling and Logging <br>
          5. Testing Validation <br>
          6. Reference Documents
          ---TOC-END-PAGE-BREAK---
          <h1 style=\"color:${{ env.HEADING_COLOR }};\">1. Introduction</h1>"

          ALL_DOCS_GENERATED=false

          find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \) -printf '%h\n' | sort -u | while read IFLOW_DIR; do

            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_FILE="$IFLOW_DIR/${IFLOW_NAME}_Summary.md"

            VERSION=$(grep -rPho '(?<=<Version>)[^<]+' "$IFLOW_DIR" | head -n 1 || true)
            VERSION=${VERSION:-"1.0.0"}

            QUERY_FILE="query.tmp"
            echo "Generate documentation for iFlow: $IFLOW_NAME" > "$QUERY_FILE"

            find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \) -print0 |
            while IFS= read -r -d '' f; do
              echo -e "\n--- FILE: $f ---\n" >> "$QUERY_FILE"
              cat "$f" >> "$QUERY_FILE"
            done

            jq -n \
              --arg model "$MODEL_NAME" \
              --arg system "$SYSTEM_PROMPT" \
              --rawfile user "$QUERY_FILE" \
              '{model:$model,temperature:0.1,messages:[{role:"system",content:$system},{role:"user",content:$user}]}' \
              > payload.json

            RESPONSE=$(curl -s -X POST "$API_URL" \
              -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload.json)

            CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

            if [ -z "$CONTENT" ]; then
              echo "::warning::No content generated for $IFLOW_NAME"
              continue
            fi

            AUTHOR=$(git log -1 --pretty=format:'%an')
            DATE=$(date +%Y-%m-%d)
            CLEAN_NAME=$(echo "$IFLOW_NAME" | sed 's/_/ /g')

            SAP_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/sap_logo.png"
            MM_LOGO="https://raw.githubusercontent.com/Rohancherian783/trail1/main/assets/motiveminds_logo.png"

            # ---------------- GLOBAL CSS (FIXED HEADER) ----------------
            GLOBAL_STYLE="<style>
            @page { margin: 120px 40px 60px 40px; }

            .page-header {
              position: fixed;
              top: -100px;
              left: 0;
              right: 0;
              height: 80px;
            }

            .logo-left { float: left; }
            .logo-right { float: right; }

            .page-header img {
              height: 55px;
              width: auto;
            }

            table {
              width: 98%;
              border-collapse: collapse;
              border: 1px solid #000;
            }

            th, td {
              border: 1px solid #000;
              padding: 10px;
            }

            th {
              background: #f2f2f2;
            }
            </style>"

            # ---------------- FIXED HEADER ----------------
            HEADER="<div class=\"page-header\">
              <div class=\"logo-left\"><img src=\"$SAP_LOGO\"></div>
              <div class=\"logo-right\"><img src=\"$MM_LOGO\"></div>
            </div>"

            # ---------------- COVER PAGE ----------------
            COVER="<h1 style=\"text-align:center;color:${{ env.HEADING_COLOR }};font-size:3.5em;\">$CLEAN_NAME</h1>
            <h2 style=\"text-align:center;\">Technical Specification Document</h2>
            <br><br>
            <table style=\"width:60%;margin:auto;\">
              <tr><th>Author</th><td>$AUTHOR</td></tr>
              <tr><th>Date</th><td>$DATE</td></tr>
              <tr><th>Version</th><td>$VERSION</td></tr>
            </table>"

            FINAL_DOC="${GLOBAL_STYLE}${HEADER}${COVER}
            <div style=\"page-break-after:always;\"></div>
            $CONTENT"

            FINAL_DOC=$(echo "$FINAL_DOC" | sed 's|---TOC-END-PAGE-BREAK---|<div style="page-break-after:always;"></div>|')

            echo "$FINAL_DOC" > "$OUTPUT_FILE"

            ALL_DOCS_GENERATED=true
            rm -f payload.json "$QUERY_FILE"

          done

          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit and Push Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "cpi-artifacts/${{ github.event.inputs.package_id }}/**/*_Summary.md"
          git commit -m "ðŸ¤– DOCS: Fixed repeating headers for ${{ github.event.inputs.package_id }}"
          git push
