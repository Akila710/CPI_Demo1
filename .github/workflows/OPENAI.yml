name: ðŸ¤– Generation Individual iFlow Documentation (PDF)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: CPI Integration Package ID
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq pandoc texlive-latex-base

      # âœ… CREATE HEADER HTML (LOGOS ON EVERY PAGE)
      - name: Create Header HTML
        run: |
          mkdir -p pandoc_assets
          cat <<'EOF' > pandoc_assets/header.html
          <style>
          @page {
            margin-top: 100px;
          }
          header {
            position: fixed;
            top: -80px;
            left: 0;
            right: 0;
            height: 70px;
          }
          header img {
            height: 45px;
          }
          </style>

          <header>
            <table width="100%">
              <tr>
                <td align="left">
                  <img src="assets/logos/SAP.jpg">
                </td>
                <td align="right">
                  <img src="assets/logos/motiveminds_logo.png">
                </td>
              </tr>
            </table>
          </header>
          EOF

      # âœ… CREATE COVER PAGE (PAGE 1)
      - name: Create Cover HTML
        run: |
          cat <<'EOF' > pandoc_assets/cover.html
          <div style="text-align:center; margin-top:200px;">
            <h1 style="font-size:42px;">{{IFLOW_NAME}}</h1>
            <h2 style="font-weight:normal;">Technical Specification Document</h2>

            <div style="margin-top:120px; display:flex; justify-content:center;">
              <table border="1" cellpadding="8" cellspacing="0" width="60%">
                <tr><th align="left">Author</th><td>{{AUTHOR}}</td></tr>
                <tr><th align="left">Date</th><td>{{DATE}}</td></tr>
                <tr><th align="left">Version</th><td>{{VERSION}}</td></tr>
              </table>
            </div>
          </div>

          <div style="page-break-after: always;"></div>
          EOF

      # âœ… CREATE TOC CSS (PAGE 2 ONLY)
      - name: Create TOC CSS
        run: |
          cat <<'EOF' > pandoc_assets/toc.css
          #TOC {
            page-break-after: always;
          }
          #TOC h1 {
            font-size: 28px;
          }
          EOF

      # âœ… GENERATE PDF
      - name: Generate PDF Documentation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          set -e

          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"
          BASE_DIR="cpi-artifacts/$PKG_ID"

          for IFLOW_DIR in "$BASE_DIR"/*; do
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_PDF="$IFLOW_DIR/${IFLOW_NAME}.pdf"

            AUTHOR=$(git log -1 --pretty=format:'%an')
            DATE=$(date +%Y-%m-%d)
            VERSION="Draft"

            # ðŸ”¹ Call OpenAI (HTML only, no logos)
            jq -n \
              --arg model "$MODEL_NAME" \
              --arg system "Generate HTML documentation. No logos. Proper headings only." \
              --arg user "Generate documentation for iFlow $IFLOW_NAME." \
              '{model:$model,messages:[{role:"system",content:$system},{role:"user",content:$user}]}' \
              > payload.json

            RESPONSE=$(curl -s -H "Authorization: Bearer $OPENAI_API_KEY" \
              -H "Content-Type: application/json" \
              -d @payload.json "$API_URL")

            echo "$(echo "$RESPONSE" | jq -r '.choices[0].message.content')" > content.html

            # ðŸ”¹ Prepare cover page
            sed -e "s/{{IFLOW_NAME}}/$IFLOW_NAME/" \
                -e "s/{{AUTHOR}}/$AUTHOR/" \
                -e "s/{{DATE}}/$DATE/" \
                -e "s/{{VERSION}}/$VERSION/" \
                pandoc_assets/cover.html > cover_final.html

            # ðŸ”¹ Build final PDF
            pandoc cover_final.html content.html \
              --toc \
              --toc-depth=3 \
              --include-in-header pandoc_assets/header.html \
              --css pandoc_assets/toc.css \
              -o "$OUTPUT_PDF"

            rm -f payload.json content.html cover_final.html
          done

      - name: Commit and Push PDFs
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add cpi-artifacts/${{ github.event.inputs.package_id }}/*.pdf
          git commit -m "ðŸ¤– DOCS: PDF with cover, TOC, repeating logos (inline HTML/CSS)"
          git push
