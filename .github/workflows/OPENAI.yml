name: ðŸ¤– Generate Individual iFlow Documentation (DOCX Only)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq + pandoc + latex)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq pandoc texlive texlive-latex-extra

      - name: Generate Individual iFlow Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"

          # Choose DOCX or PDF
          OUTPUT_FORMAT="docx"

          BASE_PKG_DIR="cpi-artifacts/$PKG_ID"
          if [ ! -d "$BASE_PKG_DIR" ]; then
            echo "::error::Package directory not found: $BASE_PKG_DIR"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from the SINGLE iFlow provided and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the 10-point structure:
          1. High-level architecture
          2. Purpose of this iFlow
          3. Sender/Receiver systems
          4. Adapter types used
          5. Step-by-step flow explanation
          6. Mapping logic summary
          7. Groovy script explanations
          8. Error handling
          9. Security/authentication details
          10. Mermaid process diagram using 'graph TD' (blank line after closing ```)."

          # Find iFlows
          FULL_IFLOW_PATHS=$(find "$BASE_PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.iflw' \))
          if [ -z "$FULL_IFLOW_PATHS" ]; then
            echo "::warning::No iFlows found."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          IFLOW_ROOT_NAMES=$(echo "$FULL_IFLOW_PATHS" | sed "s|^$BASE_PKG_DIR/||" | cut -d/ -f1 | sort -u)
          IFLOW_FOLDERS=$(echo "$IFLOW_ROOT_NAMES" | xargs -I {} echo "$BASE_PKG_DIR/{}")

          ALL_DOCS_GENERATED=false

          for IFLOW_DIR in $IFLOW_FOLDERS; do
            IFLOW_NAME=$(basename "$IFLOW_DIR")
            MD_FILE="$IFLOW_DIR/iFlow_Summary.md"
            FINAL_DOC="$IFLOW_DIR/iFlow_Summary.$OUTPUT_FORMAT"

            echo "âž¡ Processing iFlow: $IFLOW_NAME"

            FULL_ARTIFACT_CONTENT=""
            FILES_TO_ANALYZE=$(find "$IFLOW_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' -o -name '*.iflw' \))

            if [ -z "$FILES_TO_ANALYZE" ]; then
                echo "âš ï¸ No supported artifacts found in $IFLOW_DIR. Skipping."
                continue
            fi

            # Collect all file contents
            for INPUT_FILE in $FILES_TO_ANALYZE; do
              FILE_CONTENT=$(cat "$INPUT_FILE")
              FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
              FULL_ARTIFACT_CONTENT+="$FILE_CONTENT"
              FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
            done

            USER_QUERY="Synthesize using the mandatory sections:\n\n\`\`\`text\n$FULL_ARTIFACT_CONTENT\n\`\`\`"

            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')

            MAX_RETRIES=3
            RETRIES=0

            while [ $RETRIES -lt $MAX_RETRIES ]; do
              API_RESPONSE=$(curl -s -X POST "$API_URL" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -d "$PAYLOAD")

              GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

              if [ "$GENERATED_TEXT" != "null" ]; then

                # Save temporary Markdown
                echo "$GENERATED_TEXT" > "$MD_FILE"

                echo "  ðŸ”„ Converting Markdown â†’ $OUTPUT_FORMAT"

                if [ "$OUTPUT_FORMAT" = "pdf" ]; then
                  pandoc "$MD_FILE" -o "$FINAL_DOC" --pdf-engine=xelatex
                else
                  pandoc "$MD_FILE" -o "$FINAL_DOC"
                fi

                # Remove .md file (ONLY keep final .docx or .pdf)
                rm "$MD_FILE"

                echo "  ðŸ’¾ Saved: $FINAL_DOC"
                ALL_DOCS_GENERATED=true
                break
              else
                RETRIES=$((RETRIES+1))
                echo "Retry $RETRIES..."
                sleep $((2**RETRIES))
              fi
            done
          done

          echo "docs_generated=$ALL_DOCS_GENERATED" >> $GITHUB_OUTPUT

      - name: Commit All Generated Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          PKG_ID="${{ github.event.inputs.package_id }}"
          OUTPUT_PATH="cpi-artifacts/$PKG_ID/**/iFlow_Summary.*"

          git add "$OUTPUT_PATH"

          if git diff --cached --quiet "$OUTPUT_PATH"; then
              echo "No new changes."
          else
              git commit -m "ðŸ¤– DOCS: Generated iFlow documentation (DOCX only) for package: $PKG_ID"
              git push
          fi
