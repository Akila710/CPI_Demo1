name: Restore Full Version History of a CPI Package

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "Enter CPI Package ID (Example: DEMO)"
        required: true
        type: string

jobs:
  restore:
    runs-on: ubuntu-latest

    container:
      image: engswee/flashpipe:latest

    steps:

      # -----------------------------------------------------
      # CHECKOUT FULL GIT HISTORY
      # -----------------------------------------------------
      - name: Checkout full git history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # important: fetch full commit history

      # -----------------------------------------------------
      # FIX SAFE DIRECTORY ISSUE
      # -----------------------------------------------------
      - name: Configure git safe directory
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # -----------------------------------------------------
      # FIND ALL COMMITS FOR THE PACKAGE
      # -----------------------------------------------------
      - name: Find historical commits
        id: commits
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          echo "üîç Searching commits for package: $PKG_ID"

          PACKAGE_DIR="cpi-artifacts/$PKG_ID"

          COMMITS=$(git log --pretty=format:'%H' --reverse -- "$PACKAGE_DIR")

          if [ -z "$COMMITS" ]; then
            echo "::error::No history found for $PKG_ID"
            exit 1
          fi

          echo "Found commits:"
          echo "$COMMITS"

          # Convert newline ‚Üí space-separated
          CLEAN=$(echo "$COMMITS" | tr '\n' ' ')
          echo "commit_list=$CLEAN" >> $GITHUB_OUTPUT

      # -----------------------------------------------------
      # RESTORE EACH VERSION IN ORDER
      # -----------------------------------------------------
      - name: Deploy each version sequentially
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}

          PKG_ID: ${{ github.event.inputs.package_id }}
          COMMITS_LIST: ${{ steps.commits.outputs.commit_list }}
        run: |
          PACKAGE_DIR="cpi-artifacts/$PKG_ID"
          EXIT_CODE=0

          for HASH in $COMMITS_LIST; do
            echo "========================================================"
            echo "‚è™ Restoring version from commit: $HASH"

            # Restore historical files for this version
            git checkout $HASH -- "$PACKAGE_DIR"

            if [ ! -d "$PACKAGE_DIR" ]; then
              echo "::error::Missing package in commit $HASH"
              continue
            fi

            echo "üöÄ Deploying to CPI Tenant..."

            flashpipe sync \
              --tmn-host "$TMN_HOST" \
              --oauth-host "$OAUTH_HOST" \
              --oauth-clientid "$CLIENT_ID" \
              --oauth-clientsecret "$CLIENT_SECRET" \
              --package-id "$PKG_ID" \
              --dir-artifacts "$PACKAGE_DIR" \
              --sync-package-details \
              --target tenant

            if [ $? -ne 0 ]; then
              echo "::error::Deployment failed at commit $HASH"
              EXIT_CODE=1
              break
            fi

            echo "‚úî Successfully deployed version from commit $HASH"

            # Cleanup restore to avoid mixing versions
            git checkout HEAD -- "$PACKAGE_DIR"
          done

          exit $EXIT_CODE
