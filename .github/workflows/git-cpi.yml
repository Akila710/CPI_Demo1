name: Deploy CPI iFlows to CPI

on:
  workflow_dispatch:
    inputs:
      package:
        description: "CPI package name"
        required: true
      iflows:
        description: "iFlow IDs (comma or space separated) or 'all'"
        required: true
        default: "all"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    container:
      image: engswee/flashpipe:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect iFlows
        id: detect
        run: |
          PKG="${{ github.event.inputs.package }}"

          echo "ðŸ“¦ Package: $PKG"

          if [ ! -d "cpi-artifacts/$PKG" ]; then
            echo "âŒ ERROR: Package folder not found!"
            exit 1
          fi

          RAW="${{ github.event.inputs.iflows }}"

          if [ "$RAW" = "all" ]; then
            LIST=$(ls "cpi-artifacts/$PKG")
          else
            LIST=$(echo "$RAW" | tr ',' ' ')
          fi

          LIST_ONE=$(echo "$LIST" | tr '\n' ' ')
          echo "flows=$LIST_ONE" >> $GITHUB_OUTPUT

          echo "Found iFlows: $LIST_ONE"

      - name: Deploy iFlows to CPI
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          PKG="${{ github.event.inputs.package }}"
          FLOWS="${{ steps.detect.outputs.flows }}"

          echo "ðŸš€ Deploying to CPI Package: $PKG"

          for IFLOW in $FLOWS; do
            echo "================================="
            echo "ðŸš€ Deploying iFlow ID: $IFLOW"
            echo "================================="

            flashpipe deploy \
              --tmn-host "$TMN_HOST" \
              --oauth-host "$OAUTH_HOST" \
              --oauth-clientid "$CLIENT_ID" \
              --oauth-clientsecret "$CLIENT_SECRET" \
              --artifact-ids "$IFLOW" \
              --artifact-type Integration

            echo "âœ” Deployment complete: $IFLOW"
          done
