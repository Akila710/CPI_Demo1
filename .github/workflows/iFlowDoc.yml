name: ü§ñ Generate iFlow-wise Documentation (Groq API)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "CPI Package folder under cpi-artifacts"
        required: true
        type: string

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq & unzip
        run: |
          sudo apt-get update
          sudo apt-get install -y jq unzip

      - name: Generate documentation per iFlow using Groq
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          set -e

          GROQ_URL="https://api.groq.com/openai/v1/chat/completions"
          MODEL="llama-3.3-70b-versatile"

          PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$PKG_DIR" ]; then
            echo "::error:: Package not found: $PKG_DIR"
            exit 1
          fi

          echo "üì¶ Processing Package: $PKG_ID"

          # Loop through each iFlow directory
          find "$PKG_DIR" -mindepth 1 -maxdepth 1 -type d | while read IFLOW_DIR; do

            IFLOW_NAME=$(basename "$IFLOW_DIR")
            OUTPUT_FILE="$IFLOW_DIR/iFlow_Summary.md"

            echo "‚û°Ô∏è Generating summary for iFlow: $IFLOW_NAME"

            # STEP 1 ‚Äî Collect readable text source files
            FILES=$(find "$IFLOW_DIR" -type f \
              \( -name "*.xml" -o -name "*.json" -o -name "*.groovy" \
                 -o -name "*.xslt" -o -name "*.xsl" \))

            # STEP 2 ‚Äî Handle .iflw files safely (zip OR xml)
            IFLW_FILES=$(find "$IFLOW_DIR" -type f -name "*.iflw")

            for IFLW in $IFLW_FILES; do
              echo "üì¶ Checking IFLW file: $IFLW"

              if unzip -t "$IFLW" >/dev/null 2>&1; then
                echo "üìÇ IFLW is ZIP ‚Äî extracting..."
                EXTRACT_DIR="$IFLOW_DIR/_extracted_$(basename "$IFLW")"
                mkdir -p "$EXTRACT_DIR"
                unzip -q "$IFLW" -d "$EXTRACT_DIR"

                EXTRA_FILES=$(find "$EXTRACT_DIR" -type f \
                  \( -name "*.xml" -o -name "*.groovy" -o -name "*.json" \
                     -name "*.xslt" -o -name "*.xsl" \))

                FILES="$FILES $EXTRA_FILES"
              else
                echo "üìÑ IFLW is plain XML ‚Äî adding directly"
                FILES="$FILES $IFLW"
              fi
            done

            # No readable files
            if [ -z "$FILES" ]; then
              echo "‚ö†Ô∏è No readable artifacts inside iFlow: $IFLOW_NAME"
              continue
            fi

            # STEP 3 ‚Äî Build content block
            CONTENT=""
            for FILE in $FILES; do
              echo "üìÑ Reading: $FILE"
              FILE_TEXT=$(cat "$FILE" 2>/dev/null || echo "[unreadable file]")
              CONTENT+="\n--- START FILE: $FILE ---\n$FILE_TEXT\n--- END FILE: $FILE ---\n"
            done

            # STEP 4 ‚Äî Build USER PROMPT (HEREDOC for safety)
            read -r -d '' USER_PROMPT << EOF
            Analyze this SAP CPI iFlow and produce high-quality technical documentation.

            REQUIRED SECTIONS:
            1. Purpose  
            2. Sender/Receiver systems  
            3. Adapter types used  
            4. Step-by-step flow explanation  
            5. Mapping logic (if any)  
            6. Groovy script logic summary  
            7. Error handling  
            8. Security considerations  
            9. Additional notes  

        Full iFlow contents:

            \`\`\`text
            $CONTENT
            \`\`\`
            EOF

            # STEP 5 ‚Äî Build API payload
            PAYLOAD=$(jq -n \
              --arg model "$MODEL" \
              --arg sys "You are a senior SAP CPI Integration Architect." \
              --arg usr "$USER_PROMPT" \
              '{
                model: $model,
                messages: [
                  { "role": "system", "content": $sys },
                  { "role": "user", "content": $usr }
                ],
                temperature: 0.1
              }')

            # STEP 6 ‚Äî Call Groq API
            RESPONSE=$(curl -s -X POST "$GROQ_URL" \
              -H "Authorization: Bearer '"$GROQ_API_KEY"'" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")

            SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

            if [ -z "$SUMMARY" ] || [ "$SUMMARY" == "null" ]; then
              echo "‚ùå Groq summary generation failed for: $IFLOW_NAME"
              echo "Response:"
              echo "$RESPONSE"
              continue
            fi

            echo "$SUMMARY" > "$OUTPUT_FILE"
            echo "üìù Summary saved to: $OUTPUT_FILE"

          done

      - name: Commit generated summaries
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add cpi-artifacts/**/iFlow_Summary.md || true

          if git diff --cached --quiet; then
            echo "‚Ñπ No new documentation created."
            exit 0
          fi

          git commit -m "ü§ñ Auto-generated iFlow documentation using Groq API"
          git push

          echo "üöÄ Documentation committed successfully."
