name: ü§ñ Generate Documentation for Each iFlow (GitHub Copilot)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "Enter the CPI package ID (folder inside cpi-artifacts)"
        required: true
        type: string

jobs:
  generate_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq file

      - name: Generate Documentation using GitHub Copilot
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          API_URL="https://models.inference.ai/github/v1/chat/completions"
          MODEL="gpt-4o-mini"
          PKG_DIR="cpi-artifacts/$PKG_ID"

          if [ ! -d "$PKG_DIR" ]; then
            echo "::error:: Package directory not found: $PKG_ID"
            exit 1
          fi

          echo "üì¶ Processing package: $PKG_ID"

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Create technical documentation based on CPI iFlow artifacts. Follow this structure:\n1. High-level architecture\n2. Purpose\n3. Sender/Receiver systems\n4. Adapter types used\n5. Step-by-step logic\n6. Mapping logic (XML/XSLT)\n7. Groovy script explanation\n8. Error handling\n9. Security/authentication\n10. Deployment notes"

          # Process each iFlow folder
          for FLOW_DIR in "$PKG_DIR"/*; do
            [[ -d "$FLOW_DIR" ]] || continue

            FLOW_NAME=$(basename "$FLOW_DIR")
            OUTPUT_FILE="$FLOW_DIR/IFlow_Summary.md"

            echo "üìù Processing iFlow: $FLOW_NAME"

            FULL_CONTENT="Artifacts for $FLOW_NAME:\n"

            # NULL-safe find loop (handles spaces, avoids cat errors)
            while IFS= read -r -d '' FILE; do

              # Skip unreadable files
              if [[ ! -r "$FILE" ]]; then
                echo "‚ö† Skipping unreadable file: $FILE"
                continue
              fi

              # Skip binary files
              MIME=$(file --mime-type -b "$FILE")
              case "$MIME" in
                application/*|image/*)
                  echo "‚ö† Skipping binary file: $FILE"
                  continue
                  ;;
              esac

              CONTENT=$(cat "$FILE")

              FULL_CONTENT="$FULL_CONTENT
--- FILE: $FILE ---
$CONTENT
--- END FILE ---
"
            done < <(find "$FLOW_DIR" -type f -print0)

            if [[ "$FULL_CONTENT" == "Artifacts for $FLOW_NAME:\n" ]]; then
              echo "‚ö† No usable text artifacts found in $FLOW_NAME ‚Äî skipping"
              continue
            fi

            USER_QUERY="Generate CPI iFlow documentation using the following artifacts:\n\n$FULL_CONTENT"

            # Build Copilot request
            PAYLOAD=$(jq -n \
              --arg sys "$SYSTEM_PROMPT" \
              --arg usr "$USER_QUERY" \
              --arg model "$MODEL" \
              '{
                model: $model,
                messages: [
                  {"role": "system", "content": $sys},
                  {"role": "user", "content": $usr}
                ]
              }')

            # Call Copilot Model
            RESPONSE=$(curl -s -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer '"$GITHUB_TOKEN"'" \
              -d "$PAYLOAD")

            OUTPUT=$(echo "$RESPONSE" | jq -r ".choices[0].message.content")

            if [[ "$OUTPUT" == "null" || -z "$OUTPUT" ]]; then
              echo "‚ùå Documentation failed for $FLOW_NAME"
              continue
            fi

            echo "$OUTPUT" > "$OUTPUT_FILE"
            echo "‚úÖ Documentation generated: $OUTPUT_FILE"

          done

      - name: Commit generated documentation
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          if ! ls cpi-artifacts/*/*/IFlow_Summary.md >/dev/null 2>&1; then
            echo "‚Ñπ No documentation generated ‚Äî nothing to commit."
            exit 0
          fi

          git add cpi-artifacts/*/*/IFlow_Summary.md || true

          if git commit -m "ü§ñ AI-generated CPI iFlow documentation"; then
            git push
            echo "üöÄ Documentation pushed to GitHub."
          else
            echo "‚Ñπ No changes to commit."
          fi
