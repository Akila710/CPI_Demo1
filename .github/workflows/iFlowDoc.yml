name: ü§ñ Generate Documentation for Each iFlow (GitHub Copilot ‚Äì No OpenAI Key)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "Package folder inside cpi-artifacts"
        required: true
        type: string

jobs:
  generate_docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq file

      - name: Generate documentation using Copilot Models
        env:
          PKG: ${{ github.event.inputs.package_id }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          API_URL="https://models.inference.ai/github/v1/chat/completions"
          MODEL="gpt-4o-mini"
          ROOT="cpi-artifacts/$PKG"
          MAX_SIZE=200000    # Limit total content per iFlow to prevent exit code 6

          if [[ ! -d "$ROOT" ]]; then
            echo "::error:: Package folder not found: $ROOT"
            exit 1
          fi

          echo "üì¶ Processing package: $PKG"

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Create documentation for this iFlow. Use these sections:
1. High-level architecture
2. Purpose
3. Sender/Receiver systems
4. Adapters used
5. Step-by-step flow logic
6. Mapping logic
7. Groovy script explanation
8. Error handling
9. Security/authentication
10. Deployment notes"

          # Loop each iFlow folder
          for DIR in "$ROOT"/*; do
            [[ -d "$DIR" ]] || continue

            NAME=$(basename "$DIR")
            OUT="$DIR/IFlow_Summary.md"
            CONTENTS="Collected artifacts for $NAME:\n"

            echo "üìù Processing iFlow: $NAME"

            # SAFELY scan only CPI-relevant files
            while IFS= read -r -d '' FILE; do

              # Skip large files > 50 KB
              if [[ $(stat -c%s "$FILE") -gt 50000 ]]; then
                echo "‚ö†Ô∏è Skipping large file: $FILE"
                continue
              fi

              # Skip binary files (jar, pdf, images)
              MIME=$(file -b --mime-type "$FILE")
              case "$MIME" in
                text/*|application/xml|application/json)
                  ;;
                *)
                  echo "‚ö†Ô∏è Skipping binary file: $FILE"
                  continue
                  ;;
              esac

              # Stop collecting if total exceeds safety limit
              if [[ ${#CONTENTS} -gt $MAX_SIZE ]]; then
                echo "‚ö†Ô∏è Content too large for $NAME. Stopping file load."
                break
              fi

              DATA=$(cat "$FILE")
              CONTENTS="$CONTENTS
--- FILE: $FILE ---
$DATA
--- END FILE ---
"
            done < <(find "$DIR" \( -name "*.groovy" -o -name "*.xml" -o -name "*.json" -o -name "*.xslt" \) -type f -print0)

            # No content found? Skip
            if [[ "$CONTENTS" == "Collected artifacts for $NAME:\n" ]]; then
              echo "‚ö†Ô∏è No usable artifacts found for $NAME ‚Äî skipping"
              continue
            fi

            QUERY="Generate CPI iFlow documentation using these artifacts:\n\n$CONTENTS"

            PAYLOAD=$(jq -n \
              --arg model "$MODEL" \
              --arg sys "$SYSTEM_PROMPT" \
              --arg usr "$QUERY" \
              '{
                model: $model,
                messages: [
                  {"role": "system", "content": $sys},
                  {"role": "user",  "content": $usr}
                ]
              }')

            RESPONSE=$(curl -s -X POST "$API_URL" \
              -H "Authorization: Bearer '"$TOKEN"'" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD")

            OUTPUT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

            if [[ -z "$OUTPUT" ]]; then
              echo "‚ùå Failed to generate documentation for $NAME"
              continue
            fi

            echo "$OUTPUT" > "$OUT"
            echo "‚úÖ Documentation saved: $OUT"

          done

      - name: Commit documentation
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add cpi-artifacts/*/*/IFlow_Summary.md || true

          if git commit -m "ü§ñ Copilot: Generated CPI iFlow documentation"; then
            git push
          else
            echo "‚ÑπÔ∏è No new documentation to commit"
          fi
