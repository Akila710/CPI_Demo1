name: ü§ñ Generate Single Consolidated Documentation for Package

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFcoveter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Consolidated Documentation via OpenAI API
        id: documentation_step
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          API_URL="https://api.openai.com/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"

          PKG_DIR="cpi-artifacts/$PKG_ID"
          OUTPUT_FILE="$PKG_DIR/Package_Summary.md"

          if [ ! -d "$PKG_DIR" ]; then
            echo "::error::Package directory not found at: $PKG_DIR"
            echo "::error::Please check if Package ID ('$PKG_ID') is correct."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "üîç Consolidating ALL CPI artifacts into a single request for Package: $PKG_ID"

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Your task is to analyze ALL provided code and configuration files from a single CPI package and synthesize them into ONE consolidated Markdown documentation report. You MUST adhere strictly to the following 10-point structure. Consolidate Groovy, XSLT, and iFlow logic into the relevant sections (5, 6, and 7).

          The 10 mandatory sections, using Markdown headings, are:
          1. High-level architecture
          2. Purpose of each iFlow
          3. Sender/Receiver systems (Consolidated)
          4. Adapter types used (Consolidated)
          5. Step-by-step flow explanation (For each iFlow)
          6. Mapping logic summary (Summarize XSLT, Mappings)
          7. Groovy script explanations (Summarize all scripts and their usage/purpose)
          8. Error handling
          9. Security/authentication
          10. Deployment notes
          "

          # --- Data Consolidation ---
          FULL_ARTIFACT_CONTENT=""

          FILES_TO_ANALYZE=$(find "$PKG_DIR" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' \) -print)

          if [ -z "$FILES_TO_ANALYZE" ]; then
            echo "::warning::No supported artifacts found in package '$PKG_ID'. Skipping documentation."
            echo "docs_ge_
