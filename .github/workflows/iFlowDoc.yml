name: Sync CPI Packages + Generate AI Documentation

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------
      # 1Ô∏è‚É£ CHECKOUT REPO
      # ---------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # 2Ô∏è‚É£ INSTALL REQUIRED TOOLS
      # ---------------------------------------------------
      - name: Install jq & curl
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # ---------------------------------------------------
      # 3Ô∏è‚É£ FETCH PACKAGE LIST FROM CPI
      # ---------------------------------------------------
      - name: Fetch CPI package list
        id: normalize
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          echo "üîë Generating OAuth token..."

          TOKEN_URL="https://${OAUTH_HOST}/oauth/token"

          AUTH_RESPONSE=$(curl -s -X POST "$TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET")

          TOKEN=$(echo "$AUTH_RESPONSE" | jq -r '.access_token')

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "::error:: FAILED TO GENERATE TOKEN"
            echo "$AUTH_RESPONSE"
            exit 1
          fi

          echo "üîç Fetching packages..."

          URL="https://${TMN_HOST}/api/v1/IntegrationPackages?\$format=json"
          RESULT=$(curl -s -H "Authorization: Bearer $TOKEN" "$URL")

          PACKAGE_IDS=$(echo "$RESULT" | jq -r '.d.results[].Id' | tr '\n' ' ')

          echo "packages=$PACKAGE_IDS" >> $GITHUB_OUTPUT
          echo "üì¶ Packages found: $PACKAGE_IDS"

      # ---------------------------------------------------
      # 4Ô∏è‚É£ SYNC PACKAGES (FlashPipe)
      # ---------------------------------------------------
      - name: Sync packages with FlashPipe (CPI ‚Üí Git)
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          docker run --rm \
            --user $(id -u):$(id -g) \
            -v "${GITHUB_WORKSPACE}:/workspace" \
            -w /workspace \
            -e TMN_HOST="$TMN_HOST" \
            -e OAUTH_HOST="$OAUTH_HOST" \
            -e CLIENT_ID="$CLIENT_ID" \
            -e CLIENT_SECRET="$CLIENT_SECRET" \
            engswee/flashpipe:latest \
            sh -c '
              for PKG in ${{ steps.normalize.outputs.packages }}; do
                echo "‚û° Syncing $PKG..."
                flashpipe sync \
                  --tmn-host "$TMN_HOST" \
                  --oauth-host "$OAUTH_HOST" \
                  --oauth-clientid "$CLIENT_ID" \
                  --oauth-clientsecret "$CLIENT_SECRET" \
                  --package-id "$PKG" \
                  --dir-artifacts "cpi-artifacts/$PKG" \
                  --sync-package-details
              done
            '

      # ---------------------------------------------------
      # 5Ô∏è‚É£ GENERATE DOCUMENTATION USING AI IFLOW
      # ---------------------------------------------------
      - name: Generate AI Documentation for Each iFlow
        env:
          DOC_IFLOW_URL: ${{ secrets.DOC_IFLOW_URL }}
          DOC_IFLOW_USER: ${{ secrets.DOC_IFLOW_USER }}
          DOC_IFLOW_PASS: ${{ secrets.DOC_IFLOW_PASS }}
        run: |
          echo "üìù Starting AI documentation generation..."

          for PKG in ${{ steps.normalize.outputs.packages }}; do
            PKG_DIR="cpi-artifacts/$PKG"

            if [ ! -d "$PKG_DIR" ]; then
              echo "‚ö† No folder for $PKG ‚Äî skipping."
              continue
            fi

            # ONLY iterate folders (each iFlow)
            for FLOW in $(find "$PKG_DIR" -maxdepth 1 -mindepth 1 -type d -printf "%f\n"); do
              echo "‚û° Documenting: $PKG / $FLOW"

              # --------------------------
              # DEBUGGING: capture status code
              # --------------------------
              HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$DOC_IFLOW_URL" \
                -u "$DOC_IFLOW_USER:$DOC_IFLOW_PASS" \
                -H "Content-Type: application/json" \
                -d "{\"packageId\":\"${PKG}\",\"artifactId\":\"${FLOW}\"}")

              RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | sed '$d')
              STATUS_CODE=$(echo "$HTTP_RESPONSE" | tail -n1)

              echo "üì© HTTP Status: $STATUS_CODE"
              echo "üìÑ Response Body:"
              echo "$RESPONSE_BODY"

              if [ "$STATUS_CODE" -ne 200 ]; then
                echo "::error:: AI documentation iFlow failed for $FLOW"
                continue
              fi

              DOC_PATH="$PKG_DIR/$FLOW/Documentation.md"
              echo "$RESPONSE_BODY" > "$DOC_PATH"

              echo "‚úî Saved documentation ‚Üí $DOC_PATH"
            done
          done

      # ---------------------------------------------------
      # 6Ô∏è‚É£ COMMIT + PUSH CHANGES
      # ---------------------------------------------------
      - name: Commit & Push changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "CPI Sync + AI Documentation Update" || echo "No changes"
          git push || true
