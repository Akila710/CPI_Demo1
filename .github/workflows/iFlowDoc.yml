name: ðŸ¤– Generate Documentation for Each iFlow (GitHub Copilot)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "Enter the CPI package ID (folder in cpi-artifacts)"
        required: true
        type: string

jobs:
  document_iflows:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Documentation for Each iFlow (Copilot)
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          API_URL="https://models.inference.ai/github/v1/chat/completions"
          MODEL="gpt-4o-mini"

          PKG_DIR="cpi-artifacts/$PKG_ID"

          # Validate package directory
          if [ ! -d "$PKG_DIR" ]; then
            echo "::error:: Package folder not found: $PKG_ID"
            exit 1
          fi

          echo "ðŸ“¦ Processing package: $PKG_ID"

          SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect.
          Create documentation ONLY for a single iFlow's artifacts.
          Use this 10-section structure:
          1. High-level iFlow architecture
          2. Purpose
          3. Sender/Receiver systems
          4. Adapter types used
          5. Step-by-step processing
          6. Mapping / XSLT logic
          7. Groovy script explanation
          8. Error handling
          9. Security/authentication
          10. Deployment notes"

          # Loop through every subfolder inside the package
          for FLOW_DIR in "$PKG_DIR"/*; do

            # Must be a folder
            [[ -d "$FLOW_DIR" ]] || continue

            FLOW_NAME=$(basename "$FLOW_DIR")
            OUTPUT_FILE="$FLOW_DIR/IFlow_Summary.md"
            echo "ðŸ“ Generating documentation for: $FLOW_NAME"

            # Collect artifacts
            FILES=$(find "$FLOW_DIR" -type f \( -name "iFlowContent.xml" -o -name "*.groovy" -o -name "*.xslt" \))

            if [ -z "$FILES" ]; then
              echo "âš  No supported artifacts found in iFlow: $FLOW_NAME"
              continue
            fi

            FULL_CONTENT="Artifacts for iFlow: $FLOW_NAME\n"

            for FILE in $FILES; do
              CONTENT=$(cat "$FILE")
              FULL_CONTENT="$FULL_CONTENT\n--- START FILE: $FILE ---\n$CONTENT\n--- END FILE: $FILE ---\n"
            done

            USER_QUERY="Generate documentation for this CPI iFlow using the provided content below.

$FULL_CONTENT"

            # Build request payload
            PAYLOAD=$(jq -n \
              --arg sys "$SYSTEM_PROMPT" \
              --arg usr "$USER_QUERY" \
              --arg model "$MODEL" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $sys},
                  {role: "user", content: $usr}
                ]
              }')

            # Call GitHub Copilot API
            RESPONSE=$(curl -s -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer '"$GITHUB_TOKEN"'" \
              -d "$PAYLOAD")

            OUTPUT=$(echo "$RESPONSE" | jq -r ".choices[0].message.content")

            if [[ "$OUTPUT" == "null" || -z "$OUTPUT" ]]; then
              echo "âŒ Failed to generate documentation for: $FLOW_NAME"
              continue
            fi

            echo "$OUTPUT" > "$OUTPUT_FILE"
            echo "âœ… Created: $OUTPUT_FILE"

          done

      - name: Commit Documentation Safely
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Check if any summary files exist
          if ! ls cpi-artifacts/*/*/IFlow_Summary.md >/dev/null 2>&1; then
            echo "â„¹ No documentation files generated. Skipping commit."
            exit 0
          fi

          git add cpi-artifacts/*/*/IFlow_Summary.md 2>/dev/null || true

          if git commit -m "ðŸ¤– Copilot: Generated iFlow documentation"; then
            git push
            echo "ðŸš€ Documentation pushed successfully."
          else
            echo "â„¹ No changes to commit."
          fi
