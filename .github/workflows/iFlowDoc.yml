name: ðŸ¤– Generate Single Consolidated Documentation for Package (Groq API)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "The ID of the CPI Integration Package (e.g., 'PDFconverter')."
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Dependencies (jq only)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Consolidated Documentation via Groq API
        id: documentation_step
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          # --- Configuration ---
          GROQ_URL="https://api.groq.com/openai/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"

          PKG_DIR="cpi-artifacts/$PKG_ID"
          OUTPUT_FILE="$PKG_DIR/Package_Summary.md"

          if [ ! -d "$PKG_DIR" ]; then
            echo "::error::Package directory not found at: $PKG_DIR"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "ðŸ” Consolidating ALL CPI artifacts into a single request for Package: $PKG_ID"

          # --- System Prompt (YAML-safe) ---
          SYSTEM_PROMPT=" You are a senior SAP CPI Technical Architect.
           Your task is to analyze ALL provided code and configuration files from a single CPI package and synthesize them into ONE consolidated Markdown documentation report.

           Follow this 10-section structure:

           1. High-level architecture  
           2. Purpose of each iFlow  
           3. Sender/Receiver systems (Consolidated)  
           4. Adapter types used (Consolidated)  
           5. Step-by-step flow explanation (For each iFlow)  
           6. Mapping logic summary  
           7. Groovy script explanations  
           8. Error handling  
           9. Security/authentication  
           10. Deployment notes"

          # --- Data Consolidation ---
          FULL_ARTIFACT_CONTENT=""

          # Detect ALL possible CPI artifacts
          FILES_TO_ANALYZE=$(find "$PKG_DIR" -type f \
              \( -name "*.xml" -o -name "*.json" -o -name "*.groovy" \
              -o -name "*.xslt" -o -name "*.xsl" -o -name "*.iflw" \
              -o -name "*.zip" \) )

          if [ -z "$FILES_TO_ANALYZE" ]; then
            echo "::warning::No supported artifacts found in package '$PKG_ID'."
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Append file contents
          for INPUT_FILE in $FILES_TO_ANALYZE; do
            CONTENT=$(cat "$INPUT_FILE" 2>/dev/null || echo "[Binary unreadable content]")
            FULL_ARTIFACT_CONTENT+="\n\n--- START ARTIFACT: $INPUT_FILE ---\n"
            FULL_ARTIFACT_CONTENT+="$CONTENT"
            FULL_ARTIFACT_CONTENT+="\n--- END ARTIFACT: $INPUT_FILE ---\n"
          done

          echo "Total size of consolidated input: ${#FULL_ARTIFACT_CONTENT} characters."

          USER_QUERY="Synthesize a consolidated package-level documentation following the 10 mandatory sections.

\`\`\`text
$FULL_ARTIFACT_CONTENT
\`\`\`"

          # --- Build Payload ---
          PAYLOAD=$(jq -n \
            --arg system "$SYSTEM_PROMPT" \
            --arg query "$USER_QUERY" \
            --arg model "$MODEL_NAME" \
            '{
              model: $model,
              messages: [
                {role: "system", content: $system},
                {role: "user", content: $query}
              ],
              temperature: 0.1
            }')

          # --- API Call ---
          API_RESPONSE=$(curl -s -X POST "$GROQ_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer '"$GROQ_API_KEY"'" \
            -d "$PAYLOAD")

          GENERATED_TEXT=$(echo "$API_RESPONSE" | jq -r ".choices[0].message.content")

          if [ "$GENERATED_TEXT" == "null" ] || [ -z "$GENERATED_TEXT" ]; then
            echo "âŒ Groq API failed"
            echo "$API_RESPONSE"
            echo "docs_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "  âœ… Consolidated Documentation generated successfully."
          echo "$GENERATED_TEXT" > "$OUTPUT_FILE"
          echo "  ðŸ’¾ Saved consolidated documentation to $OUTPUT_FILE"

          echo "docs_generated=true" >> $GITHUB_OUTPUT

      - name: Commit Consolidated Documentation
        if: steps.documentation_step.outputs.docs_generated == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          PKG_ID="${{ github.event.inputs.package_id }}"
          OUTPUT_PATH="cpi-artifacts/$PKG_ID/Package_Summary.md"

          if [ ! -f "$OUTPUT_PATH" ]; then
            echo "âš  No documentation file found to commit."
            exit 0
          fi

          git add "$OUTPUT_PATH" || true

          if git diff --cached --quiet; then
            echo "â„¹ No meaningful documentation changes. Skipping commit."
            exit 0
          fi
          git commit -m "ðŸ¤– DOCS: Consolidated Package Summary generated for package: $PKG_ID (Groq API)"
          git push
          echo "âœ… Documentation committed and pushed."
