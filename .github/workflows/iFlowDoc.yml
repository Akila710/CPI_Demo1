name: Generate iFlow Documentation

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "Package folder inside cpi-artifacts"
        required: true
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq file

      - name: Generate documentation per iFlow
        env:
          PKG: ${{ github.event.inputs.package_id }}
          TOKEN: ${{ secrets.OPENAI_API_KEY }}
        run: |
          API="https://api.openai.com/v1/chat/completions"
          MODEL="gpt-4o-mini"

          ROOT="cpi-artifacts/$PKG"

          if [[ ! -d "$ROOT" ]]; then
            echo "::error:: Folder not found: $ROOT"
            exit 1
          fi

          echo "Processing package: $PKG"

          PROMPT="You are a senior SAP CPI Technical Architect. Create documentation for this iFlow. Use these sections:
          1. High-level architecture
          2. Purpose
          3. Sender/Receiver systems
          4. Adapters used
          5. Step-by-step logic
          6. Mapping logic
          7. Groovy script explanation
          8. Error handling
          9. Security/authentication
          10. Deployment notes"

          for IFLOW in "$ROOT"/*; do
            [[ -d "$IFLOW" ]] || continue

            NAME=$(basename "$IFLOW")
            OUT="$IFLOW/IFlow_Summary.md"

            echo "→ Processing iFlow: $NAME"

            CONTENTS="Artifacts for $NAME:\n"

            # Loop through all readable text files
            while IFS= read -r -d '' FILE; do
              MIME=$(file -b --mime-type "$FILE")

              case "$MIME" in
                text/*|application/xml|application/json)
                  ;;
                *) 
                  echo "Skipping binary file: $FILE"
                  continue
                  ;;
              esac

              DATA=$(cat "$FILE")
              CONTENTS="$CONTENTS\n--- FILE: $FILE ---\n$DATA\n--- END FILE ---\n"
            done < <(find "$IFLOW" -type f -print0)

            QUERY="Generate CPI iFlow documentation using this content:\n\n$CONTENTS"

            REQ=$(jq -n \
              --arg sys "$PROMPT" \
              --arg usr "$QUERY" \
              --arg mdl "$MODEL" \
              '{
                model: $mdl,
                messages: [
                  {"role":"system", "content":$sys},
                  {"role":"user", "content":$usr}
                ]
              }')

            RES=$(curl -s -X POST "$API" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer '"$TOKEN"'" \
              -d "$REQ")

            DOC=$(echo "$RES" | jq -r ".choices[0].message.content // empty")

            if [[ -z "$DOC" ]]; then
              echo "❌ Failed to generate documentation for $NAME"
              continue
            fi

            echo "$DOC" > "$OUT"
            echo "✓ Documentation saved: $OUT"

          done

      - name: Commit updates
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          git add cpi-artifacts/*/*/IFlow_Summary.md || true

          if git commit -m "AI: Generated iFlow documentation"; then
            git push
          else
            echo "Nothing to commit."
          fi
