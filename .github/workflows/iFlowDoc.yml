name: ðŸ¤– Generate Documentation Per iFlow (Groq API)

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "CPI Package ID (folder name inside cpi-artifacts)"
        required: true
        type: string

jobs:
  document:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Generate Documentation for Each iFlow
        id: generate_docs
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          GROQ_URL="https://api.groq.com/openai/v1/chat/completions"
          MODEL_NAME="gpt-4o-mini"

          PKG_DIR="cpi-artifacts/$PKG_ID"

          if [[ ! -d "$PKG_DIR" ]]; then
            echo "::error:: Package folder not found: $PKG_DIR"
            exit 1
          fi

          echo "ðŸ“¦ Processing package: $PKG_ID"

          # Loop through each iFlow folder
          find "$PKG_DIR" -mindepth 1 -maxdepth 1 -type d -print0 |
          while IFS= read -r -d '' IFLOW_PATH; do

            IFLOW_NAME=$(basename "$IFLOW_PATH")
            echo "âž¡ Generating documentation for iFlow: $IFLOW_NAME"

            OUTPUT_FILE="$IFLOW_PATH/iFlow_Documentation.md"

            FULL_CONTENT=""
            FILES=$(find "$IFLOW_PATH" -type f \( -name 'iFlowContent.xml' -o -name '*.groovy' -o -name '*.xslt' \))

            if [[ -z "$FILES" ]]; then
              echo "âš  No supported artifacts found for $IFLOW_NAME. Skipping."
              continue
            fi

            for FILE in $FILES; do
              CONTENT=$(cat "$FILE")
              FULL_CONTENT+="\n\n--- START ARTIFACT: $FILE ---\n$CONTENT\n--- END ARTIFACT: $FILE ---\n"
            done

            SYSTEM_PROMPT="You are a senior SAP CPI Technical Architect. Create detailed documentation for this SINGLE iFlow using the provided artifacts.
Use EXACTLY this structure:

1. High-level architecture  
2. Purpose of the iFlow  
3. Sender/Receiver systems  
4. Adapter types used  
5. Step-by-step flow logic  
6. Mapping logic  
7. Groovy scripts explanation  
8. Error handling  
9. Security/authentication  
10. Deployment notes  
"

            USER_QUERY="Analyze all artifacts from the iFlow '$IFLOW_NAME' and produce full documentation.
\`\`\`text
$FULL_CONTENT
\`\`\`"

            PAYLOAD=$(jq -n \
              --arg system "$SYSTEM_PROMPT" \
              --arg query "$USER_QUERY" \
              --arg model "$MODEL_NAME" \
              '{
                model: $model,
                messages: [
                  {role: "system", content: $system},
                  {role: "user", content: $query}
                ],
                temperature: 0.1
              }')

            RESPONSE=$(curl -s -X POST "$GROQ_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer '"$GROQ_API_KEY"'" \
              -d "$PAYLOAD")

            DOC=$(echo "$RESPONSE" | jq -r '.choices[0].message.content')

            if [[ "$DOC" == "null" || -z "$DOC" ]]; then
              echo "âŒ Groq API failed for iFlow $IFLOW_NAME"
              echo "Response: $RESPONSE"
              continue
            fi

            echo "$DOC" > "$OUTPUT_FILE"
            echo "  âœ… Saved documentation: $OUTPUT_FILE"

          done

      - name: Commit Documentation Changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add cpi-artifacts/**/iFlow_Documentation.md

          if git diff --cached --quiet; then
            echo "â„¹ No new documentation generated."
          else
            git commit -m "ðŸ¤– Auto-generated iFlow documentation using Groq API (gpt-4o-mini)"
            git push
            echo "âœ… Documentation committed."
          fi
