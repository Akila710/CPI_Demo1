name: Sync Multiple CPI Packages

on:
  workflow_dispatch:
    inputs:
      packages:
        description: "Enter package names (comma or space separated)"
        required: true
        default: "Make, Demo"

jobs:
  sync:
    runs-on: ubuntu-latest

    container:
      image: engswee/flashpipe:latest

    steps:

      - name: Install tools (needed for shell parsing)
        run: |
          apk update
          apk add bash

      - name: Checkout repository
        uses: actions/checkout@v4

      # STEP 1 — Normalize input ("Make,Demo" → "Make Demo")
      - name: Normalize package list
        id: normalize
        run: |
          RAW="${{ github.event.inputs.packages }}"
          CLEANED=$(echo "$RAW" | tr ',' ' ')
          echo "CLEANED=$CLEANED"
          echo "packages=$CLEANED" >> $GITHUB_OUTPUT

      # STEP 2 — Loop and sync all packages
      - name: Sync selected packages
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          for PKG in ${{ steps.normalize.outputs.packages }}; do
            echo "======================================"
            echo "➡ Syncing CPI Package: $PKG"
            echo "======================================"

            flashpipe sync \
              --tmn-host "$TMN_HOST" \
              --oauth-host "$OAUTH_HOST" \
              --oauth-clientid "$CLIENT_ID" \
              --oauth-clientsecret "$CLIENT_SECRET" \
              --package-id "$PKG" \
              --dir-artifacts "cpi-artifacts/$PKG" \
              --sync-package-details

            echo "✔ Completed: $PKG"
          done

      # STEP 3 — Commit updated artifacts
      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Synced packages: ${{ github.event.inputs.packages }}" || echo "No changes"
          git push || true
