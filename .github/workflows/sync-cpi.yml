name: Restore Full Version History of a CPI Package

on:
  workflow_dispatch:
    inputs:
      package_id:
        description: "Enter CPI Package ID (Example: DEMO)"
        required: true
        type: string

jobs:
  restore:
    runs-on: ubuntu-latest

    container:
      image: engswee/flashpipe:latest

    steps:
      # -----------------------------------------------------
      # CHECKOUT FULL GIT HISTORY
      # -----------------------------------------------------
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------------------------------
      # FIX SAFE DIRECTORY ISSUES
      # -----------------------------------------------------
      - name: Configure git safe directory
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # -----------------------------------------------------
      # FIND HISTORICAL COMMITS
      # -----------------------------------------------------
      - name: Find all version commits for package
        id: commits
        env:
          PKG_ID: ${{ github.event.inputs.package_id }}
        run: |
          echo "üîç Searching for all version commits for package: $PKG_ID"

          PACKAGE_PATH="cpi-artifacts/$PKG_ID"

          # Find all commits that touched the package folder
          RAW_COMMITS=$(git log --pretty=format:'%H' --reverse -- "$PACKAGE_PATH")

          if [ -z "$RAW_COMMITS" ]; then
            echo "::error::No commits found for $PKG_ID"
            exit 1
          fi

          echo "Found commits:"
          echo "$RAW_COMMITS"

          # Convert newlines ‚Üí space-separated list
          COMMITS_LIST=$(echo "$RAW_COMMITS" | tr '\n' ' ')
          echo "commit_list=$COMMITS_LIST" >> $GITHUB_OUTPUT

      # -----------------------------------------------------
      # RESTORE & DEPLOY EACH VERSION
      # -----------------------------------------------------
      - name: Deploy each historical version sequentially
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
          PKG_ID: ${{ github.event.inputs.package_id }}
          COMMITS: ${{ steps.commits.outputs.commit_list }}
        run: |
          PACKAGE_DIR="cpi-artifacts/$PKG_ID"
          EXIT_CODE=0

          for HASH in $COMMITS; do
            echo "=========================================================="
            echo "‚è™ Restoring commit: $HASH"
            
            # Extract only this version
            git checkout $HASH -- "$PACKAGE_DIR"

            if [ ! -d "$PACKAGE_DIR" ]; then
              echo "::error::Package folder missing in commit $HASH. Skipping."
              continue
            fi

            echo "üöÄ Deploying version from commit $HASH..."

            flashpipe sync \
              --tmn-host "$TMN_HOST" \
