name: Sync CPI â†’ Git (with AI Docs)

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl unzip

      # ------------------------------
      # 1. GET OAUTH TOKEN
      # ------------------------------
      - name: Get OAuth Token
        id: token
        env:
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          TOKEN_URL="https://$OAUTH_HOST/oauth/token"
          RES=$(curl -s -X POST "$TOKEN_URL" \
             -H "Content-Type: application/x-www-form-urlencoded" \
             -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET")
          TOKEN=$(echo "$RES" | jq -r ".access_token")
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      # ------------------------------
      # 2. FETCH ALL PACKAGES
      # ------------------------------
      - name: Get CPI Packages
        id: packages
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          TOKEN: ${{ steps.token.outputs.token }}
        run: |
          URL="https://$TMN_HOST/api/v1/IntegrationPackages?\$format=json"
          RES=$(curl -s -H "Authorization: Bearer $TOKEN" "$URL")
          PKGS=$(echo "$RES" | jq -r ".d.results[].Id")
          echo "packages=$PKGS" >> $GITHUB_OUTPUT

      # ------------------------------
      # 3. DOWNLOAD ALL iFLOWS + VERSIONS
      # ------------------------------
      - name: Download all iFlows & Versions
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          TOKEN: ${{ steps.token.outputs.token }}
          PACKAGES: ${{ steps.packages.outputs.packages }}
        run: |
          for PKG in $PACKAGES; do
            echo "ðŸ“¦ Package: $PKG"
            mkdir -p "cpi-artifacts/$PKG"

            # Get iFlows inside package
            LIST_URL="https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts?\$filter=PackageId eq '$PKG'&\$format=json"
            FLOWS=$(curl -s -H "Authorization: Bearer $TOKEN" "$LIST_URL" | jq -r ".d.results[].Id")

            for FLOW in $FLOWS; do
              echo "âž¡ iFlow: $FLOW"
              mkdir -p "cpi-artifacts/$PKG/$FLOW/versions"

              # Get ALL versions
              VER_URL="https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts('$FLOW')/ArtifactVersions?\$format=json"
              VERS=$(curl -s -H "Authorization: Bearer $TOKEN" "$VER_URL" | jq -r ".d.results[].Version")

              for VER in $VERS; do
                echo "â¬‡ Download Version: $VER"
                ZIPFILE="$FLOW-$VER.zip"

                curl -s -H "Authorization: Bearer $TOKEN" \
                  "https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts(Id='$FLOW',Version='$VER')/Content" \
                  -o "$ZIPFILE"

                mkdir -p "cpi-artifacts/$PKG/$FLOW/versions/$VER"
                unzip -o "$ZIPFILE" -d "cpi-artifacts/$PKG/$FLOW/versions/$VER" > /dev/null
                rm "$ZIPFILE"
              done
            done
          done

      # ------------------------------
      # 4. GENERATE DOCUMENTATION FOR EACH FLOW
      # ------------------------------
      - name: Generate AI Documentation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          for PKG in $(ls cpi-artifacts); do
            for FLOW in $(ls cpi-artifacts/$PKG); do
              SUMMARY_FILE="cpi-artifacts/$PKG/$FLOW/summary.md"

              echo "ðŸ“ Generating documentation for $FLOW"

              CONTENT=$(find "cpi-artifacts/$PKG/$FLOW/versions" -type f -name "*.iflw" -exec cat {} \; | head -c 8000)

              DOC=$(curl -s https://api.openai.com/v1/chat/completions \
                -H "Authorization: Bearer $OPENAI_API_KEY" \
                -H "Content-Type: application/json" \
                -d "{
                  \"model\": \"gpt-4o-mini\",
                  \"messages\": [
                    {\"role\": \"system\", \"content\": \"You are an expert SAP CPI documentation generator.\"},
                    {\"role\": \"user\", \"content\": \"Generate a clear summary for this iFlow:\n$CONTENT\"}
                  ]
                }" | jq -r ".choices[0].message.content")

              echo "$DOC" > "$SUMMARY_FILE"
              echo "âœ” Documentation created: $SUMMARY_FILE"
            done
          done

      # ------------------------------
      # 5. Commit & Push
      # ------------------------------
      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Sync CPI â†’ Git (with docs)" || echo "No changes"
          git push || true
