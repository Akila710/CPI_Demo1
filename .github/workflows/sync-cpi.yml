name: Sync Multiple CPI Packages

on:
  workflow_dispatch:
    inputs:
      packages:
        description: "Enter package names (comma or space separated)"
        required: true
        default: "Make, Demo"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Normalize package list
        id: normalize
        run: |
          CLEANED="$(echo '${{ github.event.inputs.packages }}' | tr ',' ' ' | xargs)"
          echo "packages=$CLEANED" >> $GITHUB_OUTPUT

      - name: Sync packages using FlashPipe (Docker)
        run: |
          for PKG in ${{ steps.normalize.outputs.packages }}; do
            echo "âž¡ Syncing $PKG"
            docker run --rm \
              -v "$GITHUB_WORKSPACE:/workspace" \
              engswee/flashpipe:latest \
              flashpipe sync \
                --tmn-host "${{ secrets.DEV_TMN_HOST }}" \
                --oauth-host "${{ secrets.DEV_OAUTH_HOST }}" \
                --oauth-clientid "${{ secrets.DEV_CLIENT_ID }}" \
                --oauth-clientsecret "${{ secrets.DEV_CLIENT_SECRET }}" \
                --package-id "$PKG" \
                --dir-artifacts "/workspace/cpi-artifacts/$PKG" \
                --sync-package-details
          done

      - name: Commit & push
        run: |
          cd "$GITHUB_WORKSPACE"

          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add .
          git commit -m "Synced packages: ${{ github.event.inputs.packages }}" || echo "No changes"
          git push || true
