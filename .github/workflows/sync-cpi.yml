name: Sync All CPI Versions to GitHub

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:

      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl unzip

      - name: Get OAuth Token
        id: token
        env:
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
        run: |
          TOKEN_URL="https://$OAUTH_HOST/oauth/token"
          RESPONSE=$(curl -s -X POST "$TOKEN_URL" \
            -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET")
          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: Fetch all packages
        id: packages
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          TOKEN: ${{ steps.token.outputs.token }}
        run: |
          RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" \
            "https://$TMN_HOST/api/v1/IntegrationPackages?\$format=json")
          PKGS=$(echo "$RESPONSE" | jq -r ".d.results[].Id")
          echo "$PKGS" > packages.txt
          echo "packages=$(echo $PKGS | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Fetch all iFlows + ALL versions
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          TOKEN: ${{ steps.token.outputs.token }}
        run: |
          while read PKG; do
            echo "ðŸ“¦ Processing Package: $PKG"

            ARTIFACTS=$(curl -s -H "Authorization: Bearer $TOKEN" \
              "https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts?\$filter=PackageId eq '$PKG'&\$format=json")

            for FLOW in $(echo "$ARTIFACTS" | jq -r ".d.results[].Id"); do
              echo "âž¡ iFlow: $FLOW"

              # Fetch all versions
              VERSIONS=$(curL -s -H "Authorization: Bearer $TOKEN" \
                "https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts('$FLOW')/ArtifactVersions?\$format=json")

              echo "$VERSIONS" | jq -r ".d.results[].Version" > tmpversions.txt

              while read VER; do
                echo "â¬‡ Downloading Version $VER of $FLOW"

                curl -s \
                  -H "Authorization: Bearer $TOKEN" \
                  "https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts(Id='$FLOW',Version='$VER')/Content" \
                  -o "$FLOW-$VER.zip"

                mkdir -p "cpi-artifacts/$PKG/$FLOW/versions/$VER"
                unzip -o "$FLOW-$VER.zip" -d "cpi-artifacts/$PKG/$FLOW/versions/$VER"
                rm "$FLOW-$VER.zip"
              done < tmpversions.txt
            done
          done < packages.txt

      - name: Commit & Push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add cpi-artifacts
          git commit -m "Fetched all CPI versions" || true
          git push
