name: Sync All CPI Packages Automatically

on:
  workflow_dispatch:

jobs:
  sync_all:
    runs-on: ubuntu-latest

    container:
      image: engswee/flashpipe:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # STEP 1 — Fetch all package IDs from CPI
      - name: List CPI Packages
        id: list_packages
        run: |
          echo "Fetching package list..."

          flashpipe list-packages \
            --tmn-host "${{ secrets.DEV_TMN_HOST }}" \
            --oauth-host "${{ secrets.DEV_OAUTH_HOST }}" \
            --oauth-clientid "${{ secrets.DEV_CLIENT_ID }}" \
            --oauth-clientsecret "${{ secrets.DEV_CLIENT_SECRET }}" \
            > packages.txt

          echo "Packages found:"
          cat packages.txt

          # Make packages available for next steps
          echo "PKGS=$(paste -sd ' ' packages.txt)" >> $GITHUB_OUTPUT

      # STEP 2 — Sync each package individually
      - name: Sync Each Package
        run: |
          for PKG in ${{ steps.list_packages.outputs.PKGS }}; do
            echo "=============================="
            echo "➡ Syncing Package: $PKG"
            echo "=============================="

            flashpipe sync \
              --tmn-host "${{ secrets.DEV_TMN_HOST }}" \
              --oauth-host "${{ secrets.DEV_OAUTH_HOST }}" \
              --oauth-clientid "${{ secrets.DEV_CLIENT_ID }}" \
              --oauth-clientsecret "${{ secrets.DEV_CLIENT_SECRET }}" \
              --package-id "$PKG" \
              --dir-artifacts "cpi-artifacts/$PKG" \
              --sync-package-details

            echo "✔ Completed: $PKG"
          done

      # STEP 3 — Commit & Push results
      - name: Commit & Push Changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add .
          git commit -m "Full Sync of All CPI Packages" || echo "No changes to commit"
          git push || true
