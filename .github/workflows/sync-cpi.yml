name: Fetch All Versioned iFlows From CPI

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------
      # CHECKOUT REPOSITORY
      # -----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # INSTALL DEPENDENCIES
      # -----------------------------------------------------
      - name: Install API tools (curl, jq, unzip)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl unzip

      # -----------------------------------------------------
      # GET OAUTH TOKEN
      # -----------------------------------------------------
      - name: Fetch OAuth Token
        id: token
        env:
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
        run: |
          echo "ðŸ”‘ Requesting OAuth token..."
          TOKEN_URL="https://$OAUTH_HOST/oauth/token"

          RESPONSE=$(curl -s -X POST "$TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET")

          TOKEN=$(echo "$RESPONSE" | jq -r ".access_token")

          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "::error::Failed to get OAuth token"
            echo "$RESPONSE"
            exit 1
          fi

          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "âœ” Token generated"

      # -----------------------------------------------------
      # FETCH ALL PACKAGES
      # -----------------------------------------------------
      - name: Fetch Package List
        id: packages
        env:
          TOKEN: ${{ env.TOKEN }}
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
        run: |
          echo "ðŸ“¦ Fetching all CPI packages..."

          API_URL="https://$TMN_HOST/api/v1/IntegrationPackages?\$format=json"
          RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "$API_URL")

          PACKAGE_IDS=$(echo "$RESPONSE" | jq -r ".d.results[].Id")

          if [ -z "$PACKAGE_IDS" ]; then
            echo "::error::No packages found"
            exit 1
          fi

          echo "âœ” Found packages:"
          echo "$PACKAGE_IDS"

          echo "PACKAGES=$PACKAGE_IDS" >> $GITHUB_ENV

      # -----------------------------------------------------
      # FETCH ALL IFLOW VERSIONS FOR EACH PACKAGE
      # -----------------------------------------------------
      - name: Fetch All Versions of All iFlows
        env:
          TOKEN: ${{ env.TOKEN }}
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          PACKAGES: ${{ env.PACKAGES }}
        run: |
          echo "ðŸš€ Starting full multi-version backup..."

          for PKG in $PACKAGES; do
            echo "==================================================="
            echo "ðŸ“¦ Processing Package: $PKG"

            ART_URL="https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts?\$filter=PackageId eq '$PKG'&\$format=json"

            ART_RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "$ART_URL")
            FLOW_IDS=$(echo "$ART_RESPONSE" | jq -r ".d.results[].Id")

            if [ -z "$FLOW_IDS" ]; then
              echo "âš  No iFlows inside $PKG"
              continue
            fi

            for FLOW in $FLOW_IDS; do
              echo "âž¡ Fetching versions for iFlow: $FLOW"

              VERS_URL="https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts(Id='$FLOW')/ArtifactVersions?\$format=json"

              VERS_RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "$VERS_URL")
              VERSION_LIST=$(echo "$VERS_RESPONSE" | jq -r ".d.results[].Version")

              if [ -z "$VERSION_LIST" ]; then
                echo "âš  No versions found for $FLOW"
                continue
              fi

              echo "âœ” Versions: $VERSION_LIST"

              for VER in $VERSION_LIST; do
                echo "â¬‡ Downloading Version $VER of $FLOW..."

                ZIP_URL="https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts(Id='$FLOW',Version='$VER')/Content"
                ZIPFILE="${FLOW}-${VER}.zip"

                curl -s -H "Authorization: Bearer $TOKEN" "$ZIP_URL" -o "$ZIPFILE"

                if [ ! -f "$ZIPFILE" ]; then
                  echo "âŒ Failed to download $FLOW version $VER"
                  continue
                fi

                TARGET_DIR="cpi-artifacts/$PKG/$FLOW/versions/$VER"
                mkdir -p "$TARGET_DIR"

                unzip -o "$ZIPFILE" -d "$TARGET_DIR" >/dev/null
                rm "$ZIPFILE"

                echo "âœ” Saved: $TARGET_DIR"
              done

            done
          done

          echo "ðŸŽ‰ Backup complete â€” all versions downloaded!"

      # -----------------------------------------------------
      # COMMIT TO GITHUB
      # -----------------------------------------------------
      - name: Commit & Push changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Fetched all versioned CPI iFlows" || echo "No changes"
          git push || true
