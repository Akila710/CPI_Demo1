name: Sync CPI â†’ GitHub + Auto Documentation

on:
  workflow_dispatch:

jobs:
  sync_and_document:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write
      actions: read
      copilot: write   # REQUIRED FOR COPILOT AI

    steps:
      # ---------------------------------------------------
      # CHECKOUT REPO
      # ---------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # INSTALL DEPENDENCIES
      # ---------------------------------------------------
      - name: Install jq, curl, unzip
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl unzip

      - name: Install Copilot CLI
        run: |
          npm install -g @github/copilot-cli
          copilot-cli --version

      # ---------------------------------------------------
      # FETCH PACKAGE LIST FROM CPI
      # ---------------------------------------------------
      - name: Fetch CPI Package List
        id: package_list
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          # Generate OAuth token
          TOKEN_URL="https://$OAUTH_HOST/oauth/token"
          AUTH_RESPONSE=$(curl -s -X POST "$TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET")

          TOKEN=$(echo "$AUTH_RESPONSE" | jq -r ".access_token")

          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
            echo "::error::Token generation failed"
            exit 1
          fi

          # Fetch all packages
          URL="https://$TMN_HOST/api/v1/IntegrationPackages?\$format=json"
          RES=$(curl -s -H "Authorization: Bearer $TOKEN" "$URL")

          PKGS=$(echo "$RES" | jq -r ".d.results[].Id" | tr '\n' ' ')
          echo "Packages found: $PKGS"

          echo "packages=$PKGS" >> $GITHUB_OUTPUT

          echo "$TOKEN" > token.txt

      # ---------------------------------------------------
      # FETCH ALL IFLOWS + UNZIP + STORE IN GIT
      # ---------------------------------------------------
      - name: Download iFlows from CPI
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
        run: |
          TOKEN=$(cat token.txt)

          for PKG in ${{ steps.package_list.outputs.packages }}; do
            echo "ðŸ“¦ Processing package: $PKG"
            mkdir -p cpi-artifacts/$PKG

            ART_URL="https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts?\$filter=PackageId eq '$PKG'&\$format=json"
            ART=$(curl -s -H "Authorization: Bearer $TOKEN" "$ART_URL")

            for FLOW in $(echo "$ART" | jq -r ".d.results[].Id"); do
              echo "âž¡ Downloading iFlow: $FLOW"

              ZIPFILE="$FLOW.zip"
              curl -s \
                -H "Authorization: Bearer $TOKEN" \
                "https://$TMN_HOST/api/v1/IntegrationDesigntimeArtifacts('$FLOW')/Content" \
                -o "$ZIPFILE"

              mkdir -p "cpi-artifacts/$PKG/$FLOW"
              unzip -o "$ZIPFILE" -d "cpi-artifacts/$PKG/$FLOW" > /dev/null
              rm "$ZIPFILE"
            done
          done

      # ---------------------------------------------------
      # AI DOCUMENTATION FOR EACH IFLOW
      # ---------------------------------------------------
      - name: Generate AI documentation for each iFlow
        run: |
          BASE="cpi-artifacts"

          for PKG in $(ls $BASE); do
            echo "ðŸ“¦ Documenting package: $PKG"

            for IFLOW in $(ls $BASE/$PKG); do
              IFLOW_DIR="$BASE/$PKG/$IFLOW"

              if [ ! -d "$IFLOW_DIR" ]; then
                continue
              fi

              echo "ðŸ“ Generating documentation for $IFLOW"

              SUMMARY=$(copilot-cli explain "$IFLOW_DIR" \
                --title "Generate documentation for CPI iFlow: $IFLOW" \
                --prompt "
You are documenting an SAP CPI iFlow.
Summarize this iFlow with:
- Purpose
- Sender and receiver adapters
- Step-by-step integration logic
- Mappings and scripts used
- Exception handling
- Trigger and endpoints
Write a clean and readable Markdown file.
")

              echo "$SUMMARY" > "$IFLOW_DIR/DOCUMENTATION.md"
            done
          done

      # ---------------------------------------------------
      # COMMIT + PUSH ALL CHANGES
      # ---------------------------------------------------
      - name: Commit & push documentation + synced flows
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "Synced CPI flows + AI documentation" || echo "No changes"
          git push || true
