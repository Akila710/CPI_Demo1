name: Sync All CPI Packages (Dynamic - FINAL ATTEMPT)

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------
      # CHECKOUT REPOSITORY
      # ---------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------
      # INSTALL TOOLS
      # ---------------------------------------------------
      - name: Install Dependencies for CPI API Calls
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      # ---------------------------------------------------
      # FETCH CPI PACKAGE LIST
      # ---------------------------------------------------
      - name: Dynamic Fetch and Normalize Package List
        id: normalize
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          echo "ðŸ”‘ Generating OAuth Token via cURL..."
          TOKEN_URL="https://$OAUTH_HOST/oauth/token"

          AUTH_RESPONSE=$(curl -s -X POST "$TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials&client_id=$CLIENT_ID&client_secret=$CLIENT_SECRET")

          TOKEN=$(echo "$AUTH_RESPONSE" | jq -r ".access_token")

          if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
            echo "::error::Failed to retrieve access token."
            echo "Raw Auth Response: $AUTH_RESPONSE"
            exit 1
          fi

          echo "ðŸ” Fetching package list from tenant..."
          API_URL="https://$TMN_HOST/api/v1/IntegrationPackages?\$format=json"

          PACKAGE_RESPONSE=$(curl -s -X GET "$API_URL" \
            -H "Authorization: Bearer $TOKEN")

          PACKAGE_IDS=$(echo "$PACKAGE_RESPONSE" | jq -r ".d.results[].Id" | tr '\n' ' ')

          if [ -z "$PACKAGE_IDS" ]; then
            echo "::warning::No packages found or API call failed. Check permissions."
            exit 0
          fi

          echo "âœ… Found packages: $PACKAGE_IDS"
          echo "packages=$PACKAGE_IDS" >> $GITHUB_OUTPUT

      # ---------------------------------------------------
      # FLASHPIPE DOCKER: SYNC PACKAGES
      # ---------------------------------------------------
      - name: Run FlashPipe inside Docker (Sync Packages)
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ sec_
