name: Full CPI Tenant Backup

on:
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    container:
      image: engswee/flashpipe:latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # STEP 1 — Get OAuth Token
      - name: Generate OAuth Token
        id: token
        env:
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
        run: |
          TOKEN_URL="https://${OAUTH_HOST}/oauth/token"

          RESPONSE=$(curl -s -X POST "$TOKEN_URL" \
            -u "$CLIENT_ID:$CLIENT_SECRET" \
            -d "grant_type=client_credentials")

          TOKEN=$(echo "$RESPONSE" | jq -r '.access_token')

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "❌ FAILED: Could not generate OAuth token"
            echo "$RESPONSE"
            exit 1
          fi

          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "Access token generated"

      # STEP 2 — Fetch all package IDs
      - name: Fetch List of CPI Packages
        id: fetch_pkgs
        env:
          TOKEN: ${{ env.TOKEN }}
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
        run: |
          echo "Fetching packages..."
          curl -s \
            -H "Authorization: Bearer $TOKEN" \
            "https://${TMN_HOST}/api/v1/IntegrationPackages" \
            -o packages.json

          echo "Package list:"
          cat packages.json | jq .

          PKGS=$(jq -r '.d.results[].Id' packages.json)

          echo "PACKAGES=$PKGS"
          echo "PKG_LIST=$PKGS" >> $GITHUB_OUTPUT

      # STEP 3 — Sync each package using FlashPipe
      - name: Sync All Packages
        env:
          TMN_HOST: ${{ secrets.DEV_TMN_HOST }}
          OAUTH_HOST: ${{ secrets.DEV_OAUTH_HOST }}
          CLIENT_ID: ${{ secrets.DEV_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.DEV_CLIENT_SECRET }}
        run: |
          for PKG in ${{ steps.fetch_pkgs.outputs.PKG_LIST }}; do
            echo "=============================="
            echo "➡ Syncing package: $PKG"
            echo "=============================="

            flashpipe sync \
              --tmn-host "$TMN_HOST" \
              --oauth-host "$OAUTH_HOST" \
              --oauth-clientid "$CLIENT_ID" \
              --oauth-clientsecret "$CLIENT_SECRET" \
              --package-id "$PKG" \
              --dir-artifacts "cpi-artifacts/$PKG" \
              --sync-package-details

            echo "✔ DONE: $PKG"
          done

      # STEP 4 — Commit & push results
      - name: Commit Backup
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add .
          git commit -m "Full CPI Backup" || echo "No changes"
          git push || true
